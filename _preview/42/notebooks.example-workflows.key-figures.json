{"version":2,"kind":"Notebook","sha256":"1e59f4c8d5fed946a07719102edb5d245a426cbb9592953e09f6eb321e816de8","slug":"notebooks.example-workflows.key-figures","location":"/notebooks/example-workflows/key-figures.ipynb","dependencies":[],"frontmatter":{"title":"Reproducing Key Figures from Kay et al. (2015)","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"literal":"Anderson Banihirwe","given":"Anderson","family":"Banihirwe"},"name":"Anderson Banihirwe","id":"contributors-myst-generated-uid-0"},{"nameParsed":{"literal":"Brian Bonnlander","given":"Brian","family":"Bonnlander"},"name":"Brian Bonnlander","id":"contributors-myst-generated-uid-1"},{"nameParsed":{"literal":"Jeff de La Beaujardière","given":"Jeff","non_dropping_particle":"de","family":"La Beaujardière"},"name":"Jeff de La Beaujardière","id":"contributors-myst-generated-uid-2"},{"nameParsed":{"literal":"Scott Henderson","given":"Scott","family":"Henderson"},"name":"Scott Henderson","id":"contributors-myst-generated-uid-3"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/cesm-lens-aws-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"source_url":"https://github.com/projectpythia/cesm-lens-aws-cookbook/blob/HEAD/notebooks/example-workflows/key-figures.ipynb","edit_url":"https://github.com/projectpythia/cesm-lens-aws-cookbook/edit/HEAD/notebooks/example-workflows/key-figures.ipynb","exports":[{"format":"ipynb","filename":"key-figures.ipynb","url":"/cesm-lens-aws-cookbook/_preview/42/build/key-figures-7479a5f21a63b0c8050096e3d43feaab.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gObIpl0FI2"}],"key":"C0R1jTmpSh"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jT83cbBQ6h"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"EPPgefz1L8"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates how one might use the NCAR Community Earth System Model (CESM) Large Ensemble (LENS) data hosted on AWS S3. The notebook shows how to reproduce figures 2 and 4 from the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"TWOOn9tlWU"},{"type":"cite","url":"https://doi.org/10.1175/BAMS-D-13-00255.1","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Kay et al. (2015) paper","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"mVcFW7F56N"}],"kind":"narrative","label":"Kay:2015a","identifier":"https://doi.org/10.1175/BAMS-D-13-00255.1","enumerator":"1","key":"MCIYNCjOGE"},{"type":"text","value":" describing the CESM LENS dataset ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"iKzPgh0NUh"},{"type":"citeGroup","kind":"parenthetical","children":[{"type":"cite","kind":"parenthetical","label":"Kay:2015a","identifier":"kay:2015a","children":[{"type":"text","value":"Kay ","key":"egZ7XH0nNJ"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"IStRISjdmK"}],"key":"gpIAHgUoat"},{"type":"text","value":", 2015","key":"Qzq6a8rb0w"}],"enumerator":"1","key":"TjTxoXQpyd"}],"key":"JMzsJa5z61"},{"type":"text","value":".","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"L0coExw0Wu"}],"key":"USGtJYnZFF"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This resource is intended to be helpful for people not familiar with elements of the ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"iClw2p2V5P"},{"type":"link","url":"https://pangeo.io/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Pangeo","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Lhji1Cmi6K"}],"urlSource":"https://pangeo.io/","key":"CElFRCVZqj"},{"type":"text","value":" framework including Jupyter Notebooks, ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Qh6m6xplR0"},{"type":"link","url":"https://docs.xarray.dev/en/stable/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"nFxU0x1HMe"}],"urlSource":"https://docs.xarray.dev/en/stable/","key":"uUKCt8LbWH"},{"type":"text","value":", and ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"lyPwegIOMB"},{"type":"link","url":"https://zarr.readthedocs.io/en/stable/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Zarr","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"vop7akoltX"}],"urlSource":"https://zarr.readthedocs.io/en/stable/","key":"Rc8mRBgQHF"},{"type":"text","value":" data format, or with the original paper, so it includes additional explanation.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"QlEnDGwr1E"}],"key":"fQJHZ9Nfaj"}],"key":"NWkReHjMzH"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AR5m81tIpq"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"pPRZPKrhyC"},{"type":"table","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"VXKt5ygsL2"}],"key":"mOi54Bwhm7"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xc3ChugCAf"}],"key":"oXjyLtSsvT"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BFBVHrD8bx"}],"key":"bwe1NTw41C"}],"key":"Hgy5vzJruG"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Intro to Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"UDDAr8SDKI"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro","key":"FTFvlvWmlq"}],"key":"T2l4XPsl2d"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SOjSN46Nqu"}],"key":"ErtKymxtsb"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[],"key":"oWdYiElaVv"}],"key":"oJYy2YuFsl"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Dask","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"OoKFjAP1qS"}],"key":"VFsNULYztZ"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Helpful","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"obGbyXMRwT"}],"key":"pNZPRaJcKq"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[],"key":"pE1VtzLgp1"}],"key":"asotg9CJtZ"}],"key":"VSOeAJA5dU"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"qWy8RLNyw4"}],"key":"w69SZ1gPu3"},{"type":"text","value":": 30 minutes","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"AduOjZlmQR"}],"key":"MlTvjmaO0M"}],"key":"Q1K9Md5KDj"}],"key":"Fi3iqsDpcs"}],"key":"rQKmV3uQLg"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KlMTgR2NCt"}],"key":"IJYaMxgLF8"},{"type":"block","kind":"notebook-content","children":[{"type":"div","class":"alert alert-warning","children":[{"type":"strong","children":[{"type":"text","value":"NOTE: ","key":"elF9oJ4UzY"}],"key":"pYUFLL4poz"},{"type":"text","value":"In this notebook, we access very large cloud-served datasets and use ","key":"nfF5M5hTm2"},{"type":"link","url":"https://dask.org","children":[{"type":"text","value":"Dask","key":"uoIK4fArOQ"}],"urlSource":"https://dask.org","key":"r4mGnSWMw7"},{"type":"text","value":" to parallelize our workflow. The end-to-end execution time may be on the order of an hour or more, depending on your computing resources.","key":"u3KBZzf5n9"}],"key":"nUfRv1NhOF"}],"key":"gjZZ0T9kpX"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pbmE4CfwXs"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"SmWI1EimIU"}],"key":"SNeoERlbJb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import sys\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n\nimport intake\nimport matplotlib.pyplot as plt\nfrom dask.distributed import Client\nimport numpy as np\nimport pandas as pd\nimport xarray as xr\nimport cmaps  # for NCL colormaps\nimport cartopy.crs as ccrs\nimport dask\nimport s3fs","key":"UTTMHm1NRR"},{"type":"output","id":"jXJW1IA88IkZp6OV4lYlL","data":[],"key":"zE7qTVXkJg"}],"key":"Y10lLdjZCm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dask.config.set({\"distributed.scheduler.worker-saturation\": 1.0})","key":"xu8OVur7JK"},{"type":"output","id":"ulKQ3exIBlN0qiK_EsJDH","data":[{"output_type":"execute_result","execution_count":2,"metadata":{},"data":{"text/plain":{"content":"<dask.config.set at 0x7fbeb8a14e90>","content_type":"text/plain"}}}],"key":"HM7ZZbyeSG"}],"key":"BFCJUr7GnP"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create and Connect to Dask Distributed Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NkBwvgQpbf"}],"identifier":"create-and-connect-to-dask-distributed-cluster","label":"Create and Connect to Dask Distributed Cluster","html_id":"create-and-connect-to-dask-distributed-cluster","implicit":true,"key":"P4sbyu7viY"}],"visibility":"show","key":"U9ifNBGH6E"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Here we’ll use a dask cluster to parallelize our analysis.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ta38dOdmsm"}],"key":"uV8ec5lUrQ"}],"key":"a2lcvXAYZp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"platform = sys.platform\n\nif (platform == 'win32'):\n    import multiprocessing.popen_spawn_win32\nelse:\n    import multiprocessing.popen_spawn_posix","key":"nSOCMv4nUk"},{"type":"output","id":"Am4CxWqlkjRJfIOPd4e56","data":[],"key":"ElYzL2B8oL"}],"key":"MqOVmNHPZw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client()\nclient","key":"VVmme9VIIl"},{"type":"output","id":"SrrNah6nlBHECxnFa2vmm","data":[{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"<Client: 'tcp://127.0.0.1:41481' processes=4 threads=4, memory=15.62 GiB>","content_type":"text/plain"},"text/html":{"content":"<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-444d150e-a80d-11f0-8ee3-7ced8d2b5668</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Cluster object</td>\n            <td style=\"text-align: left;\"><strong>Cluster type:</strong> distributed.LocalCluster</td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:8787/status\" target=\"_blank\">http://127.0.0.1:8787/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Cluster Info</h3></summary>\n            <div class=\"jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output\">\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\">\n    </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px; margin-top: 0px;\">LocalCluster</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">10c11da0</p>\n        <table style=\"width: 100%; text-align: left;\">\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:8787/status\" target=\"_blank\">http://127.0.0.1:8787/status</a>\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Workers:</strong> 4\n                </td>\n            </tr>\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Total threads:</strong> 4\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Total memory:</strong> 15.62 GiB\n                </td>\n            </tr>\n            \n            <tr>\n    <td style=\"text-align: left;\"><strong>Status:</strong> running</td>\n    <td style=\"text-align: left;\"><strong>Using processes:</strong> True</td>\n</tr>\n\n            \n        </table>\n\n        <details>\n            <summary style=\"margin-bottom: 20px;\">\n                <h3 style=\"display: inline;\">Scheduler Info</h3>\n            </summary>\n\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-e76ddc58-f5fe-45dd-af33-8215521e1264</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://127.0.0.1:41481\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 0 \n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:8787/status\" target=\"_blank\">http://127.0.0.1:8787/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 0\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 0 B\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 0</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:42327\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:32993/status\" target=\"_blank\">http://127.0.0.1:32993/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:40647\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-lz77dt3t\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 1</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:39453\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37957/status\" target=\"_blank\">http://127.0.0.1:37957/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43293\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-20tj7fug\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 2</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:35201\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:42789/status\" target=\"_blank\">http://127.0.0.1:42789/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:42985\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-u9_xvlue\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 3</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:35493\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:41157/status\" target=\"_blank\">http://127.0.0.1:41157/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:45319\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-7mn2t5ed\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n\n        </details>\n    </div>\n</div>\n            </details>\n        \n\n    </div>\n</div>","content_type":"text/html"}}}],"key":"RlAD9nCIYt"}],"key":"KhN7KMHwC6"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load and Prepare Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T54b3uIcY2"}],"identifier":"load-and-prepare-data","label":"Load and Prepare Data","html_id":"load-and-prepare-data","implicit":true,"key":"EXBEyrgEgu"}],"visibility":"show","key":"Gk5H5DHYQQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"catalog_url = 'https://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json'\ncol = intake.open_esm_datastore(catalog_url)\ncol","key":"sf4fPrFtyA"},{"type":"output","id":"v6metJibbRh473Yge1-RE","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mAttributeError\u001b[39m                            Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[5]\u001b[39m\u001b[32m, line 2\u001b[39m\n\u001b[32m      1\u001b[39m catalog_url = \u001b[33m'\u001b[39m\u001b[33mhttps://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json\u001b[39m\u001b[33m'\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m2\u001b[39m col = \u001b[43mintake\u001b[49m\u001b[43m.\u001b[49m\u001b[43mopen_esm_datastore\u001b[49m\u001b[43m(\u001b[49m\u001b[43mcatalog_url\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m      3\u001b[39m col\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cla-cookbook-dev/lib/python3.11/site-packages/intake_esm/core.py:124\u001b[39m, in \u001b[36mesm_datastore.__init__\u001b[39m\u001b[34m(self, obj, progressbar, sep, registry, read_csv_kwargs, columns_with_iterables, storage_options, threaded, **intake_kwargs)\u001b[39m\n\u001b[32m    122\u001b[39m     \u001b[38;5;28mself\u001b[39m.esmcat = ESMCatalogModel.from_dict(obj)\n\u001b[32m    123\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m124\u001b[39m     \u001b[38;5;28mself\u001b[39m.esmcat = \u001b[43mESMCatalogModel\u001b[49m\u001b[43m.\u001b[49m\u001b[43mload\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    125\u001b[39m \u001b[43m        \u001b[49m\u001b[43mobj\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mstorage_options\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mstorage_options\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mread_csv_kwargs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mread_csv_kwargs\u001b[49m\n\u001b[32m    126\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    128\u001b[39m \u001b[38;5;28mself\u001b[39m.derivedcat = registry \u001b[38;5;129;01mor\u001b[39;00m default_registry\n\u001b[32m    129\u001b[39m \u001b[38;5;28mself\u001b[39m._entries = {}\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cla-cookbook-dev/lib/python3.11/site-packages/intake_esm/cat.py:255\u001b[39m, in \u001b[36mESMCatalogModel.load\u001b[39m\u001b[34m(cls, json_file, storage_options, read_csv_kwargs)\u001b[39m\n\u001b[32m    253\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[33m'\u001b[39m\u001b[33mlast_updated\u001b[39m\u001b[33m'\u001b[39m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m data:\n\u001b[32m    254\u001b[39m     data[\u001b[33m'\u001b[39m\u001b[33mlast_updated\u001b[39m\u001b[33m'\u001b[39m] = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m255\u001b[39m cat = \u001b[38;5;28;43mcls\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmodel_validate\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    256\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m cat.catalog_file:\n\u001b[32m    257\u001b[39m     cat._frames = cat._df_from_file(cat, _mapper, storage_options, read_csv_kwargs)\n\n    \u001b[31m[... skipping hidden 1 frame]\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cla-cookbook-dev/lib/python3.11/site-packages/intake_esm/cat.py:76\u001b[39m, in \u001b[36mAssets._validate_data_format\u001b[39m\u001b[34m(cls, model)\u001b[39m\n\u001b[32m     74\u001b[39m \u001b[38;5;129m@pydantic\u001b[39m.model_validator(mode=\u001b[33m'\u001b[39m\u001b[33mafter\u001b[39m\u001b[33m'\u001b[39m)\n\u001b[32m     75\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m_validate_data_format\u001b[39m(\u001b[38;5;28mcls\u001b[39m, model):\n\u001b[32m---> \u001b[39m\u001b[32m76\u001b[39m     data_format, format_column_name = \u001b[43mmodel\u001b[49m\u001b[43m.\u001b[49m\u001b[43mformat\u001b[49m, model.format_column_name\n\u001b[32m     77\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m data_format \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m \u001b[38;5;129;01mand\u001b[39;00m format_column_name \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m     78\u001b[39m         \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[33m'\u001b[39m\u001b[33mCannot set both format and format_column_name\u001b[39m\u001b[33m'\u001b[39m)\n\n\u001b[31mAttributeError\u001b[39m: 'pydantic_core._pydantic_core.ValidationInfo' object has no attribute 'format'","ename":"AttributeError","evalue":"'pydantic_core._pydantic_core.ValidationInfo' object has no attribute 'format'"}],"key":"Z1OCRivS77"}],"key":"zznTGH16gU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show the first few lines of the catalog:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MF6kObZVLt"}],"key":"KtYDRu9k90"}],"key":"non2VeJxlm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col.df.head(10)","key":"J3ht4KOglB"},{"type":"output","id":"lWWJ3WZNOnYQxsCDA7XFv","data":[],"key":"HnVU1Io8Dq"}],"key":"W9J9BudSuL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show expanded version of collection structure with details:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Gn4k9Ekkck"}],"key":"bLv8TTlpH7"}],"key":"KTTp7vhg8y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col.keys_info().head()","key":"uQxEUwIvuj"},{"type":"output","id":"pZVSbPJcq5_3xn3-iaTV5","data":[],"key":"FalxBm7Zja"}],"key":"vs8b9Hws5J"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Extract data needed to construct Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OAcp773BPn"}],"identifier":"extract-data-needed-to-construct-figure-2","label":"Extract data needed to construct Figure 2","html_id":"extract-data-needed-to-construct-figure-2","implicit":true,"key":"mdLacdazdy"}],"key":"SQosPoe57n"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Search the catalog to find the desired data, in this case the reference height temperature of the atmosphere, at daily time resolution, for the Historical, 20th Century, and RCP8.5 (IPCC Representative Concentration Pathway 8.5) experiments.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VjoV6uz0Ib"}],"key":"vXfGsGnbpc"}],"key":"NcHgBmPvgg"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col_subset = col.search(frequency=[\"daily\", \"monthly\"], component=\"atm\", variable=\"TREFHT\",\n                        experiment=[\"20C\", \"RCP85\", \"HIST\"])\n\ncol_subset","key":"Fs2a8bvtaL"},{"type":"output","id":"q13xDlso1g84hDYpYPfZ4","data":[],"key":"YQ4jv0Fs55"}],"key":"bIha96mgFB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col_subset.df","key":"uDrOcmB8bd"},{"type":"output","id":"NbpL9YgLzlROhFllp9eJo","data":[],"key":"zry92VGvZz"}],"key":"PrDBVOFJPt"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load catalog entries for subset into a dictionary of Xarray Datasets:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b95B4fTw6J"}],"key":"y8svGVWGWY"}],"key":"HKCnuVX8BC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dsets = col_subset.to_dataset_dict(zarr_kwargs={\"consolidated\": True}, storage_options={\"anon\": True})\nprint(f\"\\nDataset dictionary keys:\\n {dsets.keys()}\")","key":"Yr9g0Chdsu"},{"type":"output","id":"5w-iQWKpRZslpP2TNIJjo","data":[],"key":"P1Uesm5X9o"}],"key":"Mh27tBb8qK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define Xarray Datasets corresponding to the three experiments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DaGTTw5jAB"}],"key":"H6jZWHD39R"}],"key":"P3V9hZ9gEU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_HIST = dsets['atm.HIST.monthly']\nds_20C = dsets['atm.20C.daily']\nds_RCP85 = dsets['atm.RCP85.daily']","key":"WlWfNAjMdN"},{"type":"output","id":"r41sa-BiKXKMNmFgPrOR5","data":[],"key":"d1M9B2ijJV"}],"key":"evci0eptmq"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Use the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ot1rMjU6RX"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VoBCS5FKip"},{"type":"text","value":" utility function to display size of each dataset:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FRNTIsET6T"}],"key":"CmVe0t0ne8"}],"key":"Jz0Pc0M7ES"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from dask.utils import format_bytes\nprint(f\"Historical: {format_bytes(ds_HIST.nbytes)}\\n\"\n      f\"20th Century: {format_bytes(ds_20C.nbytes)}\\n\"\n      f\"RCP8.5: {format_bytes(ds_RCP85.nbytes)}\")","key":"lZJCHECyf8"},{"type":"output","id":"9aPiGxL43mNCMGE4sJMon","data":[],"key":"XQ6EsDQKGP"}],"key":"TpY1Nuxdfs"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, extract the Reference Height Temperature data variable:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vzDRYpUb1s"}],"key":"pVDoVGWw38"}],"key":"HJPzfv59iP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_hist = ds_HIST[\"TREFHT\"]\nt_20c = ds_20C[\"TREFHT\"]\nt_rcp = ds_RCP85[\"TREFHT\"]\nt_20c","key":"saljQJvwTu"},{"type":"output","id":"Ex0TaIJtMxGxjRCDsTtmk","data":[],"key":"sfQzT5A1tM"}],"key":"SVAcTcE9yY"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The global surface temperature anomaly was computed relative to the 1961-90 base period in the Kay et al. paper, so extract that time slice:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LhjwtlEZpl"}],"key":"jL7I92K5Iy"}],"key":"TjcHOoUDN6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_ref = t_20c.sel(time=slice(\"1961\", \"1990\"))","key":"l486EWyq0x"},{"type":"output","id":"Qgaqr7dCWDziZmUPE0aUm","data":[],"key":"bUi5jkLgBt"}],"key":"V2Gfhdho1I"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TYKx0lDcBo"}],"identifier":"figure-2","label":"Figure 2","html_id":"figure-2","implicit":true,"key":"VsYYf8eBHi"}],"visibility":"show","key":"EJ5OsvpbdV"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read grid cell areas","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bIEjyF5XSs"}],"identifier":"read-grid-cell-areas","label":"Read grid cell areas","html_id":"read-grid-cell-areas","implicit":true,"key":"FOrf7wRBv0"}],"key":"IaiaT7XvAV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Cell size varies with latitude, so this must be accounted for when computing the global mean.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Rc2bUOSsr8"}],"key":"xMjjNDsSpx"}],"key":"U4STwetAzl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cat = col.search(frequency=\"static\", component=\"atm\", experiment=[\"20C\"])\n_, grid = cat.to_dataset_dict(aggregate=False, storage_options={'anon':True}, zarr_kwargs={\"consolidated\": True}).popitem()\ngrid","key":"BU41HcPHpz"},{"type":"output","id":"PUeLlZ5-uvrl1B1TM9HtS","data":[],"key":"lnbhHEqzch"}],"key":"z4a70Ns9Ye"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cell_area = grid.area.load()\ntotal_area = cell_area.sum()\ncell_area","key":"O4UqWj4osc"},{"type":"output","id":"t1JlkEPLJC9ILRczW3Bgl","data":[],"key":"c0Bx6Prdpq"}],"key":"hzGv07VBBa"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define weighted means","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vWWdmpWhTs"}],"identifier":"define-weighted-means","label":"Define weighted means","html_id":"define-weighted-means","implicit":true,"key":"WDJe3mkIgC"}],"key":"QqlDFJdRiq"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note: ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g5HffoSwBe"},{"type":"inlineCode","value":"resample(time=\"AS\")","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NVXNMC6I96"},{"type":"text","value":" does an annual resampling based on start of calendar year. See documentation for ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZR0d8bTHLQ"},{"type":"link","url":"https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Pandas resampling options","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CXouUeWdOW"}],"urlSource":"https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects","key":"nAoEENhOnG"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T21qpQHwae"}],"key":"dj9uKYpx66"}],"key":"jMhY08MfXw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_ref_ts = (\n    (t_ref.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n    / total_area\n).mean(dim=(\"time\", \"member_id\"))\n\nt_hist_ts = (\n    (t_hist.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area\n\nt_20c_ts = (\n    (t_20c.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area\n\nt_rcp_ts = (\n    (t_rcp.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area","key":"bsBxF7IJNq"},{"type":"output","id":"gJIS9FmzV3GGloR7xkrtt","data":[],"key":"iqWdbYXQM8"}],"key":"xkeuKr7CZG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read data and compute means","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iwgQAuRU2A"}],"identifier":"read-data-and-compute-means","label":"Read data and compute means","html_id":"read-data-and-compute-means","implicit":true,"key":"NF4rfWitqq"}],"key":"qe9AFzMB4h"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dask’s “lazy execution” philosophy means that until this point we have not actually read the bulk of the data. Steps 1, 3, and 4 take a while to complete, so we include the Notebook “cell magic” directive ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PN3fFqnDUu"},{"type":"inlineCode","value":"%%time","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VuKz5QbCyT"},{"type":"text","value":" to display elapsed and CPU times after computation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"l26WPVcigD"}],"key":"LBAYLFe7Uo"}],"key":"KWYtx8Bw2v"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 1 (takes a while)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dKV4OWhkxY"}],"key":"StLqdHC1wt"}],"key":"PVMDFU0kgv"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# this cell takes a while, be patient\nt_ref_mean = t_ref_ts.load()\nt_ref_mean","key":"NSUWkCrzV0"},{"type":"output","id":"ThrU3H2FczvAFWXnawzeT","data":[],"key":"yEO6IB31ok"}],"key":"eqeSHPwReJ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 2 (executes quickly)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gVD1hxObcg"}],"key":"N908DDjko9"}],"key":"fqTE0Fk0u7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time \nt_hist_ts_df = t_hist_ts.to_series().T\n#t_hist_ts_df.head()","key":"bsuDsn55sS"},{"type":"output","id":"45GhFoj3oa1cIATM7uW6m","data":[],"key":"zLeNHfnoL3"}],"key":"w7o1mCNkA4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 3 (takes even longer than Step 1)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vzbXqFog3O"}],"key":"zp29TA6Aj7"}],"key":"QW1mCLYtD0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nt_20c_ts_df = t_20c_ts.to_series().unstack().T\nt_20c_ts_df.head()","key":"CO2Vc0t6iT"},{"type":"output","id":"2xEL3-fTXPL88UKvsQGF-","data":[],"key":"Sfx28lqlii"}],"key":"pbtCzXCoFO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 4 (similar to Step 3 in its execution time)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tP4L92legu"}],"key":"wj4ZjOki70"}],"key":"D02DIl5zAX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# This also takes a while\nt_rcp_ts_df = t_rcp_ts.to_series().unstack().T\nt_rcp_ts_df.head()","key":"wi4jnzIGJw"},{"type":"output","id":"dtCi3WdP0uS42CjoIaYEe","data":[],"key":"fmNKQM9wL6"}],"key":"xqSRqTCAYD"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get observations for Figure 2 (HadCRUT4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zG6TcZfGQI"}],"identifier":"get-observations-for-figure-2-hadcrut4","label":"Get observations for Figure 2 (HadCRUT4)","html_id":"get-observations-for-figure-2-hadcrut4","implicit":true,"key":"MVax52oGEf"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The HadCRUT4 temperature dataset is described by ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"MJ8EQHq79y"},{"type":"citeGroup","kind":"narrative","children":[{"type":"cite","kind":"narrative","label":"Morice:2012a","identifier":"morice:2012a","children":[{"type":"text","value":"Morice ","key":"Fzm62RJdAJ"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"MA6H1S4rQz"}],"key":"FwPO3z1Mw5"},{"type":"text","value":" (2012)","key":"iXNFFHHOzn"}],"enumerator":"2","key":"KqwBNvipQm"}],"key":"MdmAb2C3Wi"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WeAKplqC0h"}],"key":"Da0xPxfEWT"}],"key":"moDjlnksb0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Observational time series data for comparison with ensemble average:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BJX6tc54yi"}],"key":"ozfjtU5mmU"}],"key":"bySVNnvaOZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obsDataURL = \"https://www.esrl.noaa.gov/psd/thredds/dodsC/Datasets/cru/hadcrut4/air.mon.anom.median.nc\"\nds = xr.open_dataset(obsDataURL).load()\nds","key":"ZhhYknwHQG"},{"type":"output","id":"PRqlV7a2cMIvgLqmhMTB3","data":[],"key":"Htqbca04fp"}],"key":"wPTQu7gicJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def weighted_temporal_mean(ds):\n    \"\"\"\n    weight by days in each month\n    \"\"\"\n    time_bound_diff = ds.time_bnds.diff(dim=\"nbnds\")[:, 0]\n    wgts = time_bound_diff.groupby(\"time.year\") / time_bound_diff.groupby(\n        \"time.year\"\n    ).sum(xr.ALL_DIMS)\n    obs = ds[\"air\"]\n    cond = obs.isnull()\n    ones = xr.where(cond, 0.0, 1.0)\n    obs_sum = (obs * wgts).resample(time=\"AS\").sum(dim=\"time\")\n    ones_out = (ones * wgts).resample(time=\"AS\").sum(dim=\"time\")\n    obs_s = (obs_sum / ones_out).mean((\"lat\", \"lon\")).to_series()\n    return obs_s","key":"GUc6su6fQI"},{"type":"output","id":"VFtQ5ulhWoMhyc81DWKeC","data":[],"key":"eZyADocNLC"}],"key":"SfVOYqaZjx"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Limit observations to 20th century:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Wy5LjPJwzy"}],"key":"Kvg54CPTKh"}],"key":"REyOqxouGu"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_s = weighted_temporal_mean(ds)\nobs_s = obs_s['1920':]\nobs_s.head()","key":"P4CAH8Mzkb"},{"type":"output","id":"PKhlJZ6bKCnA9QBeQ1u8W","data":[],"key":"JEFB8RoPiU"}],"key":"FEcEvdkzu1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"all_ts_anom = pd.concat([t_20c_ts_df, t_rcp_ts_df]) - t_ref_mean.data\nyears = [val.year for val in all_ts_anom.index]\nobs_years = [val.year for val in obs_s.index]","key":"aCOWypjB3Z"},{"type":"output","id":"vekkBi23TQdyWm2BN9jVe","data":[],"key":"AFmfzVHPHK"}],"key":"j5tnT5uxmD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine ensemble member 1 data from historical and 20th century experiments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x5KpAU2GlV"}],"key":"SLLpDwrgSn"}],"key":"Zpc4ft7cht"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hist_anom = t_hist_ts_df - t_ref_mean.data\nmember1 = pd.concat([hist_anom.iloc[:-2], all_ts_anom.iloc[:,0]], verify_integrity=True)\nmember1_years = [val.year for val in member1.index]","key":"uTLhQMyV0S"},{"type":"output","id":"kN0s_-9zMeL8uge4doGqw","data":[],"key":"bL93iTYjbC"}],"key":"rbv1OjQD5O"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plotting Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JdHYfupEQv"}],"identifier":"plotting-figure-2","label":"Plotting Figure 2","html_id":"plotting-figure-2","implicit":true,"key":"hLzuiluh7E"}],"key":"YzDzcWDfgn"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Global surface temperature anomaly (1961-90 base period) for individual ensemble members, and observations:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q7wl3XQ3WB"}],"key":"VNG4wKij7e"}],"key":"hdp7KEPN4O"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ax = plt.axes()\n\nax.tick_params(right=True, top=True, direction=\"out\", length=6, width=2, grid_alpha=0.5)\nax.plot(years, all_ts_anom.iloc[:,1:], color=\"grey\")\nax.plot(obs_years, obs_s['1920':], color=\"red\")\nax.plot(member1_years, member1, color=\"black\")\n\n\nax.text(\n    0.35,\n    0.4,\n    \"observations\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"red\",\n    fontsize=10,\n)\nax.text(\n    0.35,\n    0.33,\n    \"members 2-40\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"grey\",\n    fontsize=10,\n)\nax.text(\n    0.05,\n    0.2,\n    \"member 1\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"black\",\n    fontsize=10,\n)\n\nax.set_xticks([1850, 1920, 1950, 2000, 2050, 2100])\nplt.ylim(-1, 5)\nplt.xlim(1850, 2100)\nplt.ylabel(\"Global Surface\\nTemperature Anomaly (K)\")\nplt.show()","key":"De2GvKLYul"},{"type":"output","id":"AnLS4ugnt0cBWHXLp0Hes","data":[],"key":"zVDbp8vnHM"}],"key":"XgmGxy4qdr"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Figure 4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZguJiihNjY"}],"identifier":"figure-4","label":"Figure 4","html_id":"figure-4","implicit":true,"key":"Qss1HnqleU"}],"visibility":"show","key":"rMxTMx4pFY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute linear trend for winter seasons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"M8yrre1pFn"}],"identifier":"compute-linear-trend-for-winter-seasons","label":"Compute linear trend for winter seasons","html_id":"compute-linear-trend-for-winter-seasons","implicit":true,"key":"jtpbgRiKPC"}],"key":"Ykgq1xkIkA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def linear_trend(da, dim=\"time\"):\n    da_chunk = da.chunk({dim: -1})\n    trend = xr.apply_ufunc(\n        calc_slope,\n        da_chunk,\n        vectorize=True,\n        input_core_dims=[[dim]],\n        output_core_dims=[[]],\n        output_dtypes=[np.float64],\n        dask=\"parallelized\",\n    )\n    return trend\n\n\ndef calc_slope(y):\n    \"\"\"ufunc to be used by linear_trend\"\"\"\n    x = np.arange(len(y))\n\n    # drop missing values (NaNs) from x and y\n    finite_indexes = ~np.isnan(y)\n    slope = np.nan if (np.sum(finite_indexes) < 2) else np.polyfit(x[finite_indexes], y[finite_indexes], 1)[0]\n    return slope","key":"yTsm7klh1f"},{"type":"output","id":"gag523p5mLJk75hRQCg33","data":[],"key":"l5eJrsDiDp"}],"key":"hcVrm0crzH"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute ensemble trends","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DPCEiJ0PmO"}],"identifier":"compute-ensemble-trends","label":"Compute ensemble trends","html_id":"compute-ensemble-trends","implicit":true,"key":"rdniItgEh3"}],"key":"kttVEeyOCc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time \n# Takes several minutes\nt = xr.concat([t_20c, t_rcp], dim=\"time\")\nseasons = t.sel(time=slice(\"1979\", \"2012\")).resample(time=\"QS-DEC\").mean(\"time\")\n# Include only full seasons from 1979 and 2012\nseasons = seasons.sel(time=slice(\"1979\", \"2012\")).load()","key":"RDVaaUN8r5"},{"type":"output","id":"wEBhJZThAeRT3gcBLFyKo","data":[],"key":"dI7oSuYtSE"}],"key":"NWK2QuHPXs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"winter_seasons = seasons.sel(\n    time=seasons.time.where(seasons.time.dt.month == 12, drop=True)\n)\nwinter_trends = linear_trend(\n    winter_seasons.chunk({\"lat\": 20, \"lon\": 20, \"time\": -1})\n).load() * len(winter_seasons.time)\n\n# Compute ensemble mean from the first 30 members\nwinter_trends_mean = winter_trends.isel(member_id=range(30)).mean(dim='member_id')","key":"hZVuNkxujr"},{"type":"output","id":"WFLpcK4mxDhlieAzOvj0n","data":[],"key":"NJUQLFyw88"}],"key":"TePgzRDWPo"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Make sure that we have 34 seasons:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lCzaJQLkHX"}],"key":"ydlGnEkB5z"}],"key":"VaDo0huZiF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"assert len(winter_seasons.time) == 34","key":"nn2qlsmTio"},{"type":"output","id":"-dZ7PLeptO4LUK9Q2mLXr","data":[],"key":"yhTaPlE7OP"}],"key":"XCv8VMy4oQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get observations for Figure 4 (NASA GISS GisTemp)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oo9A3FMvGU"}],"identifier":"get-observations-for-figure-4-nasa-giss-gistemp","label":"Get observations for Figure 4 (NASA GISS GisTemp)","html_id":"get-observations-for-figure-4-nasa-giss-gistemp","implicit":true,"key":"zRNPHlNBoV"}],"key":"D34BgEaj7r"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is observational time series data for comparison with ensemble average. Here we are using the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"zYx5DeFF7Q"},{"type":"link","url":"https://data.giss.nasa.gov/gistemp/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"GISS Surface Temperature Analysis (GISTEMP v4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LdmxcnXewp"}],"urlSource":"https://data.giss.nasa.gov/gistemp/","key":"NKLbND2PjJ"},{"type":"text","value":" from NASA’s Goddard Institute of Space Studies ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LAyVFyUU74"},{"type":"citeGroup","kind":"parenthetical","children":[{"type":"cite","kind":"parenthetical","label":"Lenssen:2019a","identifier":"lenssen:2019a","children":[{"type":"text","value":"Lenssen ","key":"kNF3tlGd7A"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"zRztwlD3P7"}],"key":"uDZTxrqkQu"},{"type":"text","value":", 2019","key":"j1CpjXKLdy"}],"enumerator":"3","key":"RrD1qHx8rP"}],"key":"pl8M9GnPBQ"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rgu4Uvb31T"}],"key":"dNl3OuMoXQ"}],"key":"NlypvEL1QW"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"NoSNEsb6qz"}],"key":"V3cXhFrOCH"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We will point to Project Pythia’s ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"MiMm69Epzi"},{"type":"link","url":"https://jetstream-cloud.org","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Jetstream2","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"c3zflZMa6y"}],"urlSource":"https://jetstream-cloud.org","key":"iw7qeTNCZs"},{"type":"text","value":" object-store copy of the original time series dataset, in Zarr format.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"VPZIZq5bOI"}],"key":"nBO7gS9AfI"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The dataset was obtained from ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"C1CdvCnncj"},{"type":"link","url":"https://data.giss.nasa.gov/gistemp/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NASA’s GISTEMP website","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"IsBIVHPMZ8"}],"urlSource":"https://data.giss.nasa.gov/gistemp/","key":"Joba4sA8cw"},{"type":"text","value":" in May 2024.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"klHbYhF1xV"}],"key":"sPLZY1mfVI"}],"key":"puB38nKYKd"}],"key":"zQJfA7e62w"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the URL to Project Pythia’s Jetstream2 Object Store and the path to the Zarr file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DrQyQ8fHTw"}],"key":"SL71oMW22M"}],"key":"LeIZPYn9um"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"URL = 'https://js2.jetstream-cloud.org:8001'\nfilePath = 's3://pythia/gistemp1200_GHCNv4_ERSSTv5.zarr'","key":"qsgsEM7IDc"},{"type":"output","id":"-MwFrCCD4Kz73mmM2h8rv","data":[],"key":"LgoWhebnSh"}],"key":"yHYFmv3glp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a container for the S3 file system","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"U00ToLVDgq"}],"key":"x9A7JsrgsP"}],"key":"gUMb5yyj5B"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fs = s3fs.S3FileSystem(anon=True, client_kwargs=dict(endpoint_url=URL))","key":"ZRVKxUbtFS"},{"type":"output","id":"L-yQr3RoC-h8TjSKoeTIZ","data":[],"key":"NEtworEZoF"}],"key":"r4sItk4BDJ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Link to the Zarr file as it exists on the S3 object store","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SgIwIOvW2D"}],"key":"lYSANq9epR"}],"key":"EbUBqSLdli"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"store = s3fs.S3Map(root=filePath, s3=fs, check=False )","key":"cR3BymIW5e"},{"type":"output","id":"g_yTayxjGFHXHkHI1xTFo","data":[],"key":"ZOyJOeWxmm"}],"key":"lChykzQFUT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = xr.open_zarr(store, consolidated=True, chunks=\"auto\")\nds","key":"bYJYFB0VyI"},{"type":"output","id":"xnduWxmnbQsZNziSXhq-G","data":[],"key":"CldSnirRZZ"}],"key":"VZR88CSyZU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create an Xarray ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uzWxsDqeyE"},{"type":"inlineCode","value":"Dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f5gPE8r0wF"},{"type":"text","value":" from the Zarr object","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N6TuylpvUu"}],"key":"iYUJlUrMxQ"}],"key":"ZbJpGn4LHX"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Remap longitude range from [-180, 180] to [0, 360] for plotting purposes:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i0qNTgy88n"}],"key":"NQZphjmGif"}],"key":"KAkOOWsbBJ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = ds.assign_coords(lon=((ds.lon + 360) % 360)).sortby('lon')\nds","key":"qMH7EeJ2eX"},{"type":"output","id":"bZVTXCgi4HuenRebfdZRc","data":[],"key":"BKYUukelDA"}],"key":"h2NEX5OFy9"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute observed trends","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"x4OZyjBMBG"}],"identifier":"compute-observed-trends","label":"Compute observed trends","html_id":"compute-observed-trends","implicit":true,"key":"ivFvh52tNL"}],"key":"ROO6vITlZZ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Include only full seasons from 1979 through 2012:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qAWzYTE9d7"}],"key":"uMvrObper2"}],"key":"s9yhsRLEvL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_seasons = ds.sel(time=slice(\"1979\", \"2012\")).resample(time=\"QS-DEC\").mean(\"time\")\nobs_seasons = obs_seasons.sel(time=slice(\"1979\", \"2012\")).load()\nobs_winter_seasons = obs_seasons.sel(\n    time=obs_seasons.time.where(obs_seasons.time.dt.month == 12, drop=True)\n)\nobs_winter_seasons","key":"g2zrh4mlsf"},{"type":"output","id":"Oy6aKbselqbxmaELEnDvI","data":[],"key":"nS9Xx9pxop"}],"key":"MbVa5Qcxxu"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And compute observed winter trends:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aezjwfUd5L"}],"key":"cPaydu4NYv"}],"key":"z9HY2lh4BR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_winter_trends = linear_trend(\n    obs_winter_seasons.chunk({\"lat\": 20, \"lon\": 20, \"time\": -1})\n).load() * len(obs_winter_seasons.time)\nobs_winter_trends","key":"UU4fu2eFMJ"},{"type":"output","id":"VKkj1aPp0AQXyiEhhQeMo","data":[],"key":"ImhD6feVL4"}],"key":"JMbhjE1c5U"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plotting Figure 4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Cu1Jg9bvpJ"}],"identifier":"plotting-figure-4","label":"Plotting Figure 4","html_id":"plotting-figure-4","implicit":true,"key":"lVOxZnsZbl"}],"key":"WaNOgBmtgQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Global maps of historical (1979 - 2012) boreal winter (DJF) surface air trends:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xYTRlMucDi"}],"key":"O5nCzpVmdk"}],"key":"Ws9QWnLzQ9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"contour_levels = [-6, -5, -4, -3, -2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2, 3, 4, 5, 6]\ncolor_map = cmaps.ncl_default","key":"Ca9tfIta8G"},{"type":"output","id":"hgaA6HhneFee8VTtUZXQ4","data":[],"key":"qzMAEtXLHb"}],"key":"vxfuQDOJ0g"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def make_map_plot(nplot_rows, nplot_cols, plot_index, data, plot_label):\n    \"\"\" Create a single map subplot. \"\"\"\n    ax = plt.subplot(nplot_rows, nplot_cols, plot_index, projection = ccrs.Robinson(central_longitude = 180))\n    cplot = plt.contourf(lons, lats, data,\n                         levels = contour_levels,\n                         cmap = color_map,\n                         extend = 'both',\n                         transform = ccrs.PlateCarree())\n    ax.coastlines(color = 'grey')\n    ax.text(0.01, 0.01, plot_label, fontsize = 14, transform = ax.transAxes)\n    return cplot, ax","key":"tOstesjrAR"},{"type":"output","id":"aVtltpRl73LJgh73to1-J","data":[],"key":"GkHcUwIx2m"}],"key":"HtX4sk9O1Y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# Generate plot (may take a while as many individual maps are generated)\nnumPlotRows = 8\nnumPlotCols = 4\nfigWidth = 20\nfigHeight = 30\n\nfig, axs = plt.subplots(numPlotRows, numPlotCols, figsize=(figWidth,figHeight))\n\nlats = winter_trends.lat\nlons = winter_trends.lon\n\n# Create ensemble member plots\nfor ensemble_index in range(30):\n    plot_data = winter_trends.isel(member_id = ensemble_index)\n    plot_index = ensemble_index + 1\n    plot_label = str(plot_index)\n    plotRow = ensemble_index // numPlotCols\n    plotCol = ensemble_index % numPlotCols\n    # Retain axes objects for figure colorbar\n    cplot, axs[plotRow, plotCol] = make_map_plot(numPlotRows, numPlotCols, plot_index, plot_data, plot_label)\n\n# Create plots for the ensemble mean, observations, and a figure color bar.\ncplot, axs[7,2] = make_map_plot(numPlotRows, numPlotCols, 31, winter_trends_mean, 'EM')\n\nlats = obs_winter_trends.lat\nlons = obs_winter_trends.lon\ncplot, axs[7,3] = make_map_plot(numPlotRows, numPlotCols, 32, obs_winter_trends.tempanomaly, 'OBS')\n\ncbar = fig.colorbar(cplot, ax=axs, orientation='horizontal', shrink = 0.7, pad = 0.02)\ncbar.ax.set_title('1979-2012 DJF surface air temperature trends (K/34 years)', fontsize = 16)\ncbar.set_ticks(contour_levels)\ncbar.set_ticklabels(contour_levels)","key":"bPL6XHxowL"},{"type":"output","id":"-xjzWRiJARsg6yVT3ZnLb","data":[],"key":"MuDGQjqe3j"}],"key":"vZyhqkl3S5"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Close our client:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tS3xXb8OMm"}],"key":"ClbWZStbEL"}],"key":"qxglXK762j"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close()","key":"nKNtPZrrTa"},{"type":"output","id":"hpwAO0hMXxT2ubpHAN5WO","data":[],"key":"Z4jPMqPQz9"}],"key":"xo0LQZtmwJ"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"p1KJEsMiVS"}],"key":"auyU8ptQJ1"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Summary","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WGcSoSrfDn"}],"identifier":"summary","label":"Summary","html_id":"summary","implicit":true,"key":"ErK1khPfJ6"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In this notebook, we used CESM LENS data hosted on AWS to recreate two key figures in the paper that describes the project.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"VhnZycPzVg"}],"key":"cGNX3kxSVU"},{"type":"heading","depth":3,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"What’s next?","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"N0cf7JXltl"}],"identifier":"whats-next","label":"What’s next?","html_id":"whats-next","implicit":true,"key":"P9AqIKCOIG"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"More example workflows using these datasets may be added in the future.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PDIOs2oC3L"}],"key":"PqYDl8QpmY"}],"key":"NBwHbIGkv0"}],"key":"eE0ljjCnbx"},"references":{"cite":{"order":["Kay:2015a","Morice:2012a","Lenssen:2019a"],"data":{"Kay:2015a":{"label":"Kay:2015a","enumerator":"1","doi":"10.1175/BAMS-D-13-00255.1","html":"Kay, J. E., Deser, C., Phillips, A., Mai, A., Hannay, C., Strand, G., Arblaster, J. M., Bates, S. C., Danabasoglu, G., Edwards, J., Holland, M., Kushner, P., Lamarque, J.-F., Lawrence, D., Lindsday, K., Middleton, A., Munoz, E., Neale, R., Oleson, K., … Vertenstein, M. (2015). The Community Earth System Model (CESM) Large Ensemble Project. <i>Bull. Amer. Meteor. Soc.</i> <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1175/BAMS-D-13-00255.1\">10.1175/BAMS-D-13-00255.1</a>","url":"https://doi.org/10.1175/BAMS-D-13-00255.1"},"Morice:2012a":{"label":"Morice:2012a","enumerator":"2","doi":"10.1029/2011JD017187","html":"Morice, C. P., Kennedy, J. J., Rayner, N. A., & Jones, P. D. (2012). Quantifying uncertainties in global and regional temperature change using an ensemble of observational estimates: The HadCRUT4 data set. <i>J. Geophys. Res. Atmos.</i>, <i>117</i>(D8). <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1029/2011JD017187\">10.1029/2011JD017187</a>","url":"https://doi.org/10.1029/2011JD017187"},"Lenssen:2019a":{"label":"Lenssen:2019a","enumerator":"3","doi":"10.1029/2018JD029522","html":"Lenssen, N., Schmidt, G., Hansen, J., Menne, M., Persin, A., Ruedy, R., & Zyss, D. (2019). Improvements in the GISTEMP uncertainty model. <i>Journal of Geophysical Research: Atmospheres</i>, <i>124</i>(12), 6307–6326. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1029/2018JD029522\">10.1029/2018JD029522</a>","url":"https://doi.org/10.1029/2018JD029522"}}}},"footer":{"navigation":{"prev":{"title":"Enhanced Intake-ESM Catalog Demo","url":"/notebooks/foundations/enhanced-catalog","group":"Foundations"}}},"domain":"http://localhost:3000"}