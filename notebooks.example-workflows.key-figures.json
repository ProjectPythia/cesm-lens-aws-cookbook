{"version":2,"kind":"Notebook","sha256":"81ab489a0bf23cc040fa4d634fdc0143ccf5b71a74cac6a80293435f99d210ed","slug":"notebooks.example-workflows.key-figures","location":"/notebooks/example-workflows/key-figures.ipynb","dependencies":[],"frontmatter":{"title":"Reproducing Key Figures from Kay et al. (2015)","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"literal":"Anderson Banihirwe","given":"Anderson","family":"Banihirwe"},"name":"Anderson Banihirwe","id":"contributors-myst-generated-uid-0"},{"nameParsed":{"literal":"Brian Bonnlander","given":"Brian","family":"Bonnlander"},"name":"Brian Bonnlander","id":"contributors-myst-generated-uid-1"},{"nameParsed":{"literal":"Jeff de La Beaujardière","given":"Jeff","non_dropping_particle":"de","family":"La Beaujardière"},"name":"Jeff de La Beaujardière","id":"contributors-myst-generated-uid-2"},{"nameParsed":{"literal":"Scott Henderson","given":"Scott","family":"Henderson"},"name":"Scott Henderson","id":"contributors-myst-generated-uid-3"}],"open_access":true,"license":{"content":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true},"code":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true}},"github":"https://github.com/projectpythia/cesm-lens-aws-cookbook","copyright":"2024","affiliations":[{"id":"University at Albany (State University of New York)","name":"University at Albany (State University of New York)"},{"id":"UCAR/NCAR","name":"UCAR/NCAR"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/cesm-lens-aws-cookbook/blob/main/notebooks/example-workflows/key-figures.ipynb","exports":[{"format":"ipynb","filename":"key-figures.ipynb","url":"/cesm-lens-aws-cookbook/build/key-figures-8e6ecf84ead1403d3018f3d2dc866739.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"irIJ2CN6tx"}],"key":"DWE5CNuRaU"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vbxw6EoSkI"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"nRbXXtNTe5"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates how one might use the NCAR Community Earth System Model (CESM) Large Ensemble (LENS) data hosted on AWS S3. The notebook shows how to reproduce figures 2 and 4 from the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"HkSQHw3d7m"},{"type":"cite","url":"https://doi.org/10.1175/BAMS-D-13-00255.1","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Kay et al. (2015) paper","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"wSlzY8fCC3"}],"kind":"narrative","label":"Kay:2015a","identifier":"https://doi.org/10.1175/BAMS-D-13-00255.1","enumerator":"1","key":"GgkXOLmgmo"},{"type":"text","value":" describing the CESM LENS dataset ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"oNsPBUGkOW"},{"type":"citeGroup","kind":"parenthetical","children":[{"type":"cite","kind":"parenthetical","label":"Kay:2015a","identifier":"kay:2015a","children":[{"type":"text","value":"Kay ","key":"iUN2ioG801"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"PUhc2JKkfC"}],"key":"j4r6PBe097"},{"type":"text","value":", 2015","key":"Xq1BMy7aab"}],"enumerator":"1","key":"jGDeulpWyg"}],"key":"Wnblpsws4c"},{"type":"text","value":".","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"OgIcBMpKLK"}],"key":"ny6jnqDBPW"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This resource is intended to be helpful for people not familiar with elements of the ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"QdKyof4JyB"},{"type":"link","url":"https://pangeo.io/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Pangeo","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"ViTVg1RrSa"}],"urlSource":"https://pangeo.io/","key":"UQbWeAE2CU"},{"type":"text","value":" framework including Jupyter Notebooks, ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"dF4bMD2abf"},{"type":"link","url":"https://docs.xarray.dev/en/stable/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"QGzQj1sWqy"}],"urlSource":"https://docs.xarray.dev/en/stable/","key":"Is5mKd3p46"},{"type":"text","value":", and ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"wvgpwbJBy1"},{"type":"link","url":"https://zarr.readthedocs.io/en/stable/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Zarr","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"tQr7bxL2Fs"}],"urlSource":"https://zarr.readthedocs.io/en/stable/","key":"QVBmLVOE9M"},{"type":"text","value":" data format, or with the original paper, so it includes additional explanation.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"jIc2EoguH1"}],"key":"iGFz2fjJO2"}],"key":"fu9JV60s21"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZEx9PHRdMO"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"LpC2jWdLG1"},{"type":"table","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ooLcAows2x"}],"key":"BgeRGyXZXc"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uttMs4KF2b"}],"key":"L2HtR5vm46"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cSQCFC53ip"}],"key":"yzMxAE8Umh"}],"key":"cTDqeFheXY"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Intro to Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"yI4Oe5sdYU"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro.html","key":"URiNvclgmo"}],"key":"PfddeyTWVF"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"DBjLhtD5E3"}],"key":"n1XENFpwU7"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[],"key":"FOjZXyS92q"}],"key":"D7YryIbaUx"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Dask","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"tGMP4Qyzr1"}],"key":"JfsRFocAwB"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Helpful","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ZiFsUy40pO"}],"key":"to0z13SsC5"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[],"key":"CLVfASZvII"}],"key":"AYN6qQRwy5"}],"key":"IZG8NsEGp7"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"cl4iDdbtG0"}],"key":"KlgfWTFMCc"},{"type":"text","value":": 30 minutes","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"YjLXcUB4Ng"}],"key":"RId0htQ0CD"}],"key":"RgCz9bCeWX"}],"key":"X3Yw5kRYr6"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eRt20qEgpE"}],"key":"YLWvpvW9mF"},{"type":"block","kind":"notebook-content","children":[{"type":"div","class":"alert alert-warning","children":[{"type":"strong","children":[{"type":"text","value":"NOTE: ","key":"h5FHKgALzK"}],"key":"KCywgmOd4J"},{"type":"text","value":"In this notebook, we access very large cloud-served datasets and use ","key":"YojyEoNars"},{"type":"link","url":"https://dask.org","children":[{"type":"text","value":"Dask","key":"F5rvbLa9vN"}],"urlSource":"https://dask.org","key":"TlTml6cW8h"},{"type":"text","value":" to parallelize our workflow. The end-to-end execution time may be on the order of an hour or more, depending on your computing resources.","key":"IKbEZwXBus"}],"key":"BlRMo0RKte"}],"key":"c7aD0wAfLy"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"H5td39u62q"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"GFAySN9hDQ"}],"key":"RKg0UlTBOB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import sys\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n\nimport intake\nimport matplotlib.pyplot as plt\nfrom dask.distributed import Client\nimport numpy as np\nimport pandas as pd\nimport xarray as xr\nimport cmaps  # for NCL colormaps\nimport cartopy.crs as ccrs\nimport dask\nimport s3fs","key":"GkwDh7zURP"},{"type":"output","id":"CkKyAGAh06MH0DSJVLhFT","data":[],"key":"DGHEELvSuS"}],"key":"sFN091tc6o"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dask.config.set({\"distributed.scheduler.worker-saturation\": 1.0})","key":"ohwPxu3x3T"},{"type":"output","id":"s9iRhkBj-0J6Vc6S8GIYG","data":[],"key":"v671ctl18J"}],"key":"lLpja3lFQo"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create and Connect to Dask Distributed Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZKcGasV2Sf"}],"identifier":"create-and-connect-to-dask-distributed-cluster","label":"Create and Connect to Dask Distributed Cluster","html_id":"create-and-connect-to-dask-distributed-cluster","implicit":true,"key":"cCd9DEwSXq"}],"visibility":"show","key":"BWDCSEnPAM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Here we’ll use a dask cluster to parallelize our analysis.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DqmJP2qVYw"}],"key":"AwYgIziGa9"}],"key":"Enow1vBTFb"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"platform = sys.platform\n\nif (platform == 'win32'):\n    import multiprocessing.popen_spawn_win32\nelse:\n    import multiprocessing.popen_spawn_posix","key":"qfMvp2EAxg"},{"type":"output","id":"hbi4O4f6NX7u8mR3SGkPw","data":[],"key":"T9pNSJBplZ"}],"key":"DUgQBPbX0X"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client()\nclient","key":"S4hISxP6tH"},{"type":"output","id":"vPNByGPeVLNcnSXgMePzI","data":[],"key":"uY7WB0z8y1"}],"key":"aecikKTKWb"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load and Prepare Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CkiTxICytn"}],"identifier":"load-and-prepare-data","label":"Load and Prepare Data","html_id":"load-and-prepare-data","implicit":true,"key":"YPImnH37xj"}],"visibility":"show","key":"GfGyo1qT84"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"catalog_url = 'https://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json'\ncol = intake.open_esm_datastore(catalog_url)\ncol","key":"FOujYN5ahs"},{"type":"output","id":"AgDezCOimqcQc-5kD3X7E","data":[],"key":"lX3VSOEiEy"}],"key":"sumBTGCouM"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show the first few lines of the catalog:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CYHU6dYiGw"}],"key":"j1DiWmtK0L"}],"key":"A4YEpmVxFf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col.df.head(10)","key":"kL8iT9ouh6"},{"type":"output","id":"Y8r0EGGyhX4oLx2TPBduN","data":[],"key":"G7yZimPorO"}],"key":"e4PAD61HJm"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show expanded version of collection structure with details:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Sdr7XToLej"}],"key":"wr1TkbJ4re"}],"key":"YUpLa6m1AK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col.keys_info().head()","key":"A1V9pSB9FU"},{"type":"output","id":"gSIHCHl09eGEHSEKyhHDb","data":[],"key":"UPSbiRtm4Q"}],"key":"nr5FUpXuYv"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Extract data needed to construct Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jVizVEhsn5"}],"identifier":"extract-data-needed-to-construct-figure-2","label":"Extract data needed to construct Figure 2","html_id":"extract-data-needed-to-construct-figure-2","implicit":true,"key":"rA2DCo1i9a"}],"key":"FzsCOUVSgn"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Search the catalog to find the desired data, in this case the reference height temperature of the atmosphere, at daily time resolution, for the Historical, 20th Century, and RCP8.5 (IPCC Representative Concentration Pathway 8.5) experiments.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zm2KoLr9aL"}],"key":"fIbLH93i1f"}],"key":"ZigslhNxpH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col_subset = col.search(frequency=[\"daily\", \"monthly\"], component=\"atm\", variable=\"TREFHT\",\n                        experiment=[\"20C\", \"RCP85\", \"HIST\"])\n\ncol_subset","key":"jvmg4duI5J"},{"type":"output","id":"BpiWEmr7X6amq95inlpIZ","data":[],"key":"fjGXcH4uPa"}],"key":"MM12TUFFxZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col_subset.df","key":"ip032adQjH"},{"type":"output","id":"FE7gLxctFMsDHiEuf_5sa","data":[],"key":"bVC3lnK19C"}],"key":"n033HtJGin"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load catalog entries for subset into a dictionary of Xarray Datasets:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VBRysUCLOo"}],"key":"LDsQJ4VakR"}],"key":"C3VvD3SiHZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dsets = col_subset.to_dataset_dict(zarr_kwargs={\"consolidated\": True}, storage_options={\"anon\": True})\nprint(f\"\\nDataset dictionary keys:\\n {dsets.keys()}\")","key":"kaA0srT6sJ"},{"type":"output","id":"ed1Ai_TZ2HIX30H_1zN04","data":[],"key":"JeioXjXUPN"}],"key":"Fe1Z8zxyDp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define Xarray Datasets corresponding to the three experiments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"th4evUVyQC"}],"key":"uDEOPuo7yv"}],"key":"iKaH3lO5f1"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_HIST = dsets['atm.HIST.monthly']\nds_20C = dsets['atm.20C.daily']\nds_RCP85 = dsets['atm.RCP85.daily']","key":"GFSMa6p52x"},{"type":"output","id":"cm7Gsc71P7wTp2gTwJ8cU","data":[],"key":"dHUhKbCvVi"}],"key":"wSXAd547Cp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Use the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EbqwG5uSb6"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MEYzRJDmuU"},{"type":"text","value":" utility function to display size of each dataset:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GsO5skLPkn"}],"key":"JNp2kkQgK4"}],"key":"FbqR9P204r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from dask.utils import format_bytes\nprint(f\"Historical: {format_bytes(ds_HIST.nbytes)}\\n\"\n      f\"20th Century: {format_bytes(ds_20C.nbytes)}\\n\"\n      f\"RCP8.5: {format_bytes(ds_RCP85.nbytes)}\")","key":"vkcWesvkCM"},{"type":"output","id":"jKHUNyJedc8jrwvKfEvbz","data":[],"key":"be1tdRIFsx"}],"key":"VvrF0UD1Nz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, extract the Reference Height Temperature data variable:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lVUEJPaKnr"}],"key":"YsSdBw8tNR"}],"key":"MBRtmGmwCs"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_hist = ds_HIST[\"TREFHT\"]\nt_20c = ds_20C[\"TREFHT\"]\nt_rcp = ds_RCP85[\"TREFHT\"]\nt_20c","key":"gRDwfLEuTf"},{"type":"output","id":"E9wU2iPosn1jcTj7x2GMg","data":[],"key":"jHL3ORblPu"}],"key":"uBARrXRaGW"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The global surface temperature anomaly was computed relative to the 1961-90 base period in the Kay et al. paper, so extract that time slice:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VqfJaFMw1T"}],"key":"NayJTMDPc3"}],"key":"HKQFsJFeO0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_ref = t_20c.sel(time=slice(\"1961\", \"1990\"))","key":"p3WKV0Mv4j"},{"type":"output","id":"AnyPbI6wEkaqrBKPWSn-p","data":[],"key":"quNP4KwlzW"}],"key":"VIx0fPEilO"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"S7t2pT0xZc"}],"identifier":"figure-2","label":"Figure 2","html_id":"figure-2","implicit":true,"key":"LlKwQAMczn"}],"visibility":"show","key":"AEyyobGEJT"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read grid cell areas","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W3XKr9ztV4"}],"identifier":"read-grid-cell-areas","label":"Read grid cell areas","html_id":"read-grid-cell-areas","implicit":true,"key":"u0j63RUIVd"}],"key":"BmRKUXaW9t"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Cell size varies with latitude, so this must be accounted for when computing the global mean.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"exGEhUZwCj"}],"key":"aNd4eJvuQA"}],"key":"fhXZudGv6E"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cat = col.search(frequency=\"static\", component=\"atm\", experiment=[\"20C\"])\n_, grid = cat.to_dataset_dict(aggregate=False, storage_options={'anon':True}, zarr_kwargs={\"consolidated\": True}).popitem()\ngrid","key":"ssmlX8TiEp"},{"type":"output","id":"VYavaDq4NXnchn8HpMQWj","data":[],"key":"x9pwziHEA1"}],"key":"H4VYfhdbDj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cell_area = grid.area.load()\ntotal_area = cell_area.sum()\ncell_area","key":"QnglrdMH6Z"},{"type":"output","id":"i8UNK7LPqtLWP9JNwJizS","data":[],"key":"VBpFHEe7c9"}],"key":"UD7kFw9pY7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define weighted means","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"L4shY0wvdK"}],"identifier":"define-weighted-means","label":"Define weighted means","html_id":"define-weighted-means","implicit":true,"key":"LShKKLI1N3"}],"key":"rCKHDumlac"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note: ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZJKWUyCUVo"},{"type":"inlineCode","value":"resample(time=\"AS\")","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZBLPeSDdIX"},{"type":"text","value":" does an annual resampling based on start of calendar year. See documentation for ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SxyEnjLnwE"},{"type":"link","url":"https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Pandas resampling options","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mLLHymJ55E"}],"urlSource":"https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects","key":"pP9hZxE2CM"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NPKD8L4nAY"}],"key":"WmmqCksEhZ"}],"key":"pBS5XDT8FV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_ref_ts = (\n    (t_ref.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n    / total_area\n).mean(dim=(\"time\", \"member_id\"))\n\nt_hist_ts = (\n    (t_hist.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area\n\nt_20c_ts = (\n    (t_20c.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area\n\nt_rcp_ts = (\n    (t_rcp.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area","key":"zqhCKdIjgt"},{"type":"output","id":"cz2TatjX-dKu1gX6-kYFk","data":[],"key":"Pjaui2Pd2g"}],"key":"esoybowCa5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read data and compute means","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iKpddPce5q"}],"identifier":"read-data-and-compute-means","label":"Read data and compute means","html_id":"read-data-and-compute-means","implicit":true,"key":"NUXXUpnlrq"}],"key":"XuFcHNR9YA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dask’s “lazy execution” philosophy means that until this point we have not actually read the bulk of the data. Steps 1, 3, and 4 take a while to complete, so we include the Notebook “cell magic” directive ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Fzhd5fze3I"},{"type":"inlineCode","value":"%%time","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k9zYSMJaP5"},{"type":"text","value":" to display elapsed and CPU times after computation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pYi8B7dUmn"}],"key":"OovgVd05ny"}],"key":"xmLzuU7SBy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 1 (takes a while)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"r4WETezGKu"}],"key":"bwJDkZn42A"}],"key":"SUUieTPEZC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# this cell takes a while, be patient\nt_ref_mean = t_ref_ts.load()\nt_ref_mean","key":"OFBVNwh2vL"},{"type":"output","id":"CUzLJj-Ko2VUMO8IS1wy_","data":[],"key":"ZSQscwy77d"}],"key":"ZXOZKBnh1N"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 2 (executes quickly)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xovKKKSSlh"}],"key":"obYr8eQjAG"}],"key":"FVAr2VH02l"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time \nt_hist_ts_df = t_hist_ts.to_series().T\n#t_hist_ts_df.head()","key":"e9K7ObxUUG"},{"type":"output","id":"VLYJGGfPV1SuEcGFxnIik","data":[],"key":"AYi7RMEwCb"}],"key":"RZofhien3H"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 3 (takes even longer than Step 1)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lkj5SdGdc7"}],"key":"cXKHwkIjWX"}],"key":"HzWhGs6KNl"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nt_20c_ts_df = t_20c_ts.to_series().unstack().T\nt_20c_ts_df.head()","key":"pAjfMdfSeO"},{"type":"output","id":"wvpwTUSa50TZ1edmTxll6","data":[],"key":"M5y9pLyckP"}],"key":"aMx0OjOCCQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 4 (similar to Step 3 in its execution time)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"S2RHQjWJ0a"}],"key":"JlQKFzneg0"}],"key":"rCCNnRdkXi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# This also takes a while\nt_rcp_ts_df = t_rcp_ts.to_series().unstack().T\nt_rcp_ts_df.head()","key":"PKrL6XPQCp"},{"type":"output","id":"e0thnfW2w3ffGfvKk-uRi","data":[],"key":"zENG3a7DAs"}],"key":"JkjSYXJuWQ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get observations for Figure 2 (HadCRUT4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eMewTr7Qce"}],"identifier":"get-observations-for-figure-2-hadcrut4","label":"Get observations for Figure 2 (HadCRUT4)","html_id":"get-observations-for-figure-2-hadcrut4","implicit":true,"key":"s3dSq2RAuP"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The HadCRUT4 temperature dataset is described by ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"SR8s0Vc2cE"},{"type":"citeGroup","kind":"narrative","children":[{"type":"cite","kind":"narrative","label":"Morice:2012a","identifier":"morice:2012a","children":[{"type":"text","value":"Morice ","key":"zo3PGu1UKl"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"jqL5OHRI1e"}],"key":"jizhlDrooG"},{"type":"text","value":" (2012)","key":"SxVHdcUUTX"}],"enumerator":"2","key":"nEuHTeEpL7"}],"key":"etBYeJwXQG"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"JEA5FQY0vy"}],"key":"TwmXK8G7IV"}],"key":"fTeWpcmEpR"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Observational time series data for comparison with ensemble average:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"d02k4Zp5rn"}],"key":"bgjwp0CO0t"}],"key":"WyrHJXS8CO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obsDataURL = \"https://www.esrl.noaa.gov/psd/thredds/dodsC/Datasets/cru/hadcrut4/air.mon.anom.median.nc\"\nds = xr.open_dataset(obsDataURL).load()\nds","key":"ui9eEjbUY8"},{"type":"output","id":"JlUQYyRk5errInUyyZBQp","data":[],"key":"TWBM3lWvca"}],"key":"TAHneH7bLj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def weighted_temporal_mean(ds):\n    \"\"\"\n    weight by days in each month\n    \"\"\"\n    time_bound_diff = ds.time_bnds.diff(dim=\"nbnds\")[:, 0]\n    wgts = time_bound_diff.groupby(\"time.year\") / time_bound_diff.groupby(\n        \"time.year\"\n    ).sum(xr.ALL_DIMS)\n    obs = ds[\"air\"]\n    cond = obs.isnull()\n    ones = xr.where(cond, 0.0, 1.0)\n    obs_sum = (obs * wgts).resample(time=\"AS\").sum(dim=\"time\")\n    ones_out = (ones * wgts).resample(time=\"AS\").sum(dim=\"time\")\n    obs_s = (obs_sum / ones_out).mean((\"lat\", \"lon\")).to_series()\n    return obs_s","key":"e4XBt0WDog"},{"type":"output","id":"UdYUEq0GO-5X4ybfcz5Ni","data":[],"key":"d3R1VPicAb"}],"key":"nMrjEAI7lN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Limit observations to 20th century:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ypt6jtUfVu"}],"key":"YSmg51ijVm"}],"key":"K5cQp0nJEn"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_s = weighted_temporal_mean(ds)\nobs_s = obs_s['1920':]\nobs_s.head()","key":"GUCjwdF4Eu"},{"type":"output","id":"N5163tFMmf3WEAK1jDc5p","data":[],"key":"CgBfsm07Pm"}],"key":"vQQ56KlCBx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"all_ts_anom = pd.concat([t_20c_ts_df, t_rcp_ts_df]) - t_ref_mean.data\nyears = [val.year for val in all_ts_anom.index]\nobs_years = [val.year for val in obs_s.index]","key":"PFLRmalRCF"},{"type":"output","id":"_s-2DCWZEeKX8sZ8Y-sCb","data":[],"key":"YPQpUWMunK"}],"key":"eEdADzxORK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine ensemble member 1 data from historical and 20th century experiments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"phvTDqfcyP"}],"key":"NoPlpCsHhd"}],"key":"pPDXAxYAiG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hist_anom = t_hist_ts_df - t_ref_mean.data\nmember1 = pd.concat([hist_anom.iloc[:-2], all_ts_anom.iloc[:,0]], verify_integrity=True)\nmember1_years = [val.year for val in member1.index]","key":"BX66AvxE8O"},{"type":"output","id":"vYSiPK7hG6Q_QAuF_Ene7","data":[],"key":"EukfZoQEFl"}],"key":"mPtfufX2Xj"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plotting Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vrePEgbBu9"}],"identifier":"plotting-figure-2","label":"Plotting Figure 2","html_id":"plotting-figure-2","implicit":true,"key":"qNuBPZgZAv"}],"key":"vFAQrrk2dK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Global surface temperature anomaly (1961-90 base period) for individual ensemble members, and observations:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xyR7PouftO"}],"key":"BsxNUdTi6M"}],"key":"YGdALGR9xo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ax = plt.axes()\n\nax.tick_params(right=True, top=True, direction=\"out\", length=6, width=2, grid_alpha=0.5)\nax.plot(years, all_ts_anom.iloc[:,1:], color=\"grey\")\nax.plot(obs_years, obs_s['1920':], color=\"red\")\nax.plot(member1_years, member1, color=\"black\")\n\n\nax.text(\n    0.35,\n    0.4,\n    \"observations\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"red\",\n    fontsize=10,\n)\nax.text(\n    0.35,\n    0.33,\n    \"members 2-40\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"grey\",\n    fontsize=10,\n)\nax.text(\n    0.05,\n    0.2,\n    \"member 1\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"black\",\n    fontsize=10,\n)\n\nax.set_xticks([1850, 1920, 1950, 2000, 2050, 2100])\nplt.ylim(-1, 5)\nplt.xlim(1850, 2100)\nplt.ylabel(\"Global Surface\\nTemperature Anomaly (K)\")\nplt.show()","key":"QnqJFvsMnP"},{"type":"output","id":"wRa8BX2voesHlfymBg_1I","data":[],"key":"NxxkuaEgE6"}],"key":"mAEe3DBPcU"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Figure 4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BkIipSdlbe"}],"identifier":"figure-4","label":"Figure 4","html_id":"figure-4","implicit":true,"key":"PahFKZc7AQ"}],"visibility":"show","key":"aKdtBayxMP"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute linear trend for winter seasons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"a46P9mHTfR"}],"identifier":"compute-linear-trend-for-winter-seasons","label":"Compute linear trend for winter seasons","html_id":"compute-linear-trend-for-winter-seasons","implicit":true,"key":"gfGaSgL2Ye"}],"key":"tVkrXJxAOe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def linear_trend(da, dim=\"time\"):\n    da_chunk = da.chunk({dim: -1})\n    trend = xr.apply_ufunc(\n        calc_slope,\n        da_chunk,\n        vectorize=True,\n        input_core_dims=[[dim]],\n        output_core_dims=[[]],\n        output_dtypes=[np.float64],\n        dask=\"parallelized\",\n    )\n    return trend\n\n\ndef calc_slope(y):\n    \"\"\"ufunc to be used by linear_trend\"\"\"\n    x = np.arange(len(y))\n\n    # drop missing values (NaNs) from x and y\n    finite_indexes = ~np.isnan(y)\n    slope = np.nan if (np.sum(finite_indexes) < 2) else np.polyfit(x[finite_indexes], y[finite_indexes], 1)[0]\n    return slope","key":"TI6ZLmnROB"},{"type":"output","id":"KztE-5LQMwRQLS4VfkLEd","data":[],"key":"v6RSpO74qj"}],"key":"U16yldBYph"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute ensemble trends","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EXxYBBdtZr"}],"identifier":"compute-ensemble-trends","label":"Compute ensemble trends","html_id":"compute-ensemble-trends","implicit":true,"key":"MRAxJKko3v"}],"key":"dnPZWky3F6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time \n# Takes several minutes\nt = xr.concat([t_20c, t_rcp], dim=\"time\")\nseasons = t.sel(time=slice(\"1979\", \"2012\")).resample(time=\"QS-DEC\").mean(\"time\")\n# Include only full seasons from 1979 and 2012\nseasons = seasons.sel(time=slice(\"1979\", \"2012\")).load()","key":"MFY7YyTgau"},{"type":"output","id":"tbyKkt9cltapDhWlqDoy1","data":[],"key":"iMI5Pzjdw6"}],"key":"BH2WXxUXbC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"winter_seasons = seasons.sel(\n    time=seasons.time.where(seasons.time.dt.month == 12, drop=True)\n)\nwinter_trends = linear_trend(\n    winter_seasons.chunk({\"lat\": 20, \"lon\": 20, \"time\": -1})\n).load() * len(winter_seasons.time)\n\n# Compute ensemble mean from the first 30 members\nwinter_trends_mean = winter_trends.isel(member_id=range(30)).mean(dim='member_id')","key":"bcA1v8ZyuF"},{"type":"output","id":"w7bYbesMQiF1DXuv5BSmA","data":[],"key":"flTFCOjlDT"}],"key":"GJ2pMNYXnK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Make sure that we have 34 seasons:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fJm7fAQiI1"}],"key":"afZYnX5Y1e"}],"key":"YAycF7uyG7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"assert len(winter_seasons.time) == 34","key":"Pt1WC5pGvj"},{"type":"output","id":"JpwZq2LmqG_-BBYPyGYOu","data":[],"key":"B4d9d2QCj2"}],"key":"I44GZ2VPji"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get observations for Figure 4 (NASA GISS GisTemp)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mtHY9yDARF"}],"identifier":"get-observations-for-figure-4-nasa-giss-gistemp","label":"Get observations for Figure 4 (NASA GISS GisTemp)","html_id":"get-observations-for-figure-4-nasa-giss-gistemp","implicit":true,"key":"JjtjKJiEfz"}],"key":"VwB8KTxCpL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is observational time series data for comparison with ensemble average. Here we are using the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AQXQOPUsIe"},{"type":"link","url":"https://data.giss.nasa.gov/gistemp/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"GISS Surface Temperature Analysis (GISTEMP v4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PoeSM7ERyl"}],"urlSource":"https://data.giss.nasa.gov/gistemp/","key":"blUqcfh7YE"},{"type":"text","value":" from NASA’s Goddard Institute of Space Studies ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Uln59vJbZ7"},{"type":"citeGroup","kind":"parenthetical","children":[{"type":"cite","kind":"parenthetical","label":"Lenssen:2019a","identifier":"lenssen:2019a","children":[{"type":"text","value":"Lenssen ","key":"LYihFembC8"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"xp0yJU8Mld"}],"key":"zN8KZfG64r"},{"type":"text","value":", 2019","key":"IhxrBlC3XN"}],"enumerator":"3","key":"MFfooWJTck"}],"key":"DGUvZBaCuf"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jqLWpdJNCt"}],"key":"jk7sIAz4EX"}],"key":"sPzCKxDVZ5"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"G3U9XXzpX0"}],"key":"P8XCynLa2T"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We will point to Project Pythia’s ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"KtF2JCqGyf"},{"type":"link","url":"https://jetstream-cloud.org","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Jetstream2","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"a3ytJyT5kn"}],"urlSource":"https://jetstream-cloud.org","key":"a1Dotjuqy7"},{"type":"text","value":" object-store copy of the original time series dataset, in Zarr format.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"b7PGGTox0r"}],"key":"nXU6MpPJiS"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The dataset was obtained from ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"B2SzLm9Hfr"},{"type":"link","url":"https://data.giss.nasa.gov/gistemp/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NASA’s GISTEMP website","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"E22IAN6o5K"}],"urlSource":"https://data.giss.nasa.gov/gistemp/","key":"r73cMMLEbH"},{"type":"text","value":" in May 2024.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"s0MgN5bXrH"}],"key":"YcyO1lo76C"}],"key":"dVGRmkv8Xq"}],"key":"jzNmRoNlMO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the URL to Project Pythia’s Jetstream2 Object Store and the path to the Zarr file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eUeFc7TZPq"}],"key":"G4KMPSuiHW"}],"key":"BGqD9umkrN"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"URL = 'https://js2.jetstream-cloud.org:8001'\nfilePath = 's3://pythia/gistemp1200_GHCNv4_ERSSTv5.zarr'","key":"Jd8dXgO59E"},{"type":"output","id":"qFdnrNpQk0wVYvPpBhoNq","data":[],"key":"fnW0gulKOL"}],"key":"clRGkAP8jS"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a container for the S3 file system","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SX6YpZ6al6"}],"key":"M0sl3x9ucv"}],"key":"nosmpBDokF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fs = s3fs.S3FileSystem(anon=True, client_kwargs=dict(endpoint_url=URL))","key":"etud6PwLNe"},{"type":"output","id":"BrYwEtt2PgTlogABWvLrM","data":[],"key":"wKXLvkyNhH"}],"key":"Hjg3wVQH3T"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Link to the Zarr file as it exists on the S3 object store","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gMsfxZSztz"}],"key":"SGx3fkt5MI"}],"key":"tuzX1oaOVO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"store = s3fs.S3Map(root=filePath, s3=fs, check=False )","key":"FP0lOwIuh0"},{"type":"output","id":"nwQUY1HyndaNL_NH4hGvp","data":[],"key":"jwCmJZR9Uv"}],"key":"JSvvEHU91G"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = xr.open_zarr(store, consolidated=True, chunks=\"auto\")\nds","key":"xQZC1glehS"},{"type":"output","id":"wVJLisbS_Qz1LNiLqjU6I","data":[],"key":"pe7672iHh8"}],"key":"PDqPYs4TE3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create an Xarray ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UdZpNR4TCm"},{"type":"inlineCode","value":"Dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uPa4OE7ZVU"},{"type":"text","value":" from the Zarr object","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yH0CxpUUH1"}],"key":"bpYRL53kYJ"}],"key":"obQ2ZrRYjD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Remap longitude range from [-180, 180] to [0, 360] for plotting purposes:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lfO8cgySbj"}],"key":"idHhaIxqAD"}],"key":"Czv4nm2VPo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = ds.assign_coords(lon=((ds.lon + 360) % 360)).sortby('lon')\nds","key":"fJ36fqT0bD"},{"type":"output","id":"DzUn8dKbuLwciuAMvOrTd","data":[],"key":"X6csauRfLr"}],"key":"c8MsD9PWEq"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute observed trends","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qJ8W08WlZT"}],"identifier":"compute-observed-trends","label":"Compute observed trends","html_id":"compute-observed-trends","implicit":true,"key":"cUEeKdsRkl"}],"key":"HOw03C1qeD"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Include only full seasons from 1979 through 2012:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jtgaYKZY39"}],"key":"hH5ii7xvHR"}],"key":"bxthxmnFVo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_seasons = ds.sel(time=slice(\"1979\", \"2012\")).resample(time=\"QS-DEC\").mean(\"time\")\nobs_seasons = obs_seasons.sel(time=slice(\"1979\", \"2012\")).load()\nobs_winter_seasons = obs_seasons.sel(\n    time=obs_seasons.time.where(obs_seasons.time.dt.month == 12, drop=True)\n)\nobs_winter_seasons","key":"LI1lsYpcNT"},{"type":"output","id":"DJsyiH3ZJSFL1QMiuahhm","data":[],"key":"k7fKt3RJeU"}],"key":"bG5C7Zpnm3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And compute observed winter trends:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"k1hz8VBEmB"}],"key":"mpi1fblXn9"}],"key":"R7F8xrGGzF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_winter_trends = linear_trend(\n    obs_winter_seasons.chunk({\"lat\": 20, \"lon\": 20, \"time\": -1})\n).load() * len(obs_winter_seasons.time)\nobs_winter_trends","key":"TPGyVjr6MW"},{"type":"output","id":"ECeU2nsOx_r2yTq10CY2d","data":[],"key":"mSif9DhTdu"}],"key":"LSosseHhVG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plotting Figure 4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zr2IpyvRDB"}],"identifier":"plotting-figure-4","label":"Plotting Figure 4","html_id":"plotting-figure-4","implicit":true,"key":"MAZ4A3VnYg"}],"key":"YpY7Rqbnoa"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Global maps of historical (1979 - 2012) boreal winter (DJF) surface air trends:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eRLkDFjbsi"}],"key":"Dj4rsbWsZw"}],"key":"wmjIMYMKLI"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"contour_levels = [-6, -5, -4, -3, -2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2, 3, 4, 5, 6]\ncolor_map = cmaps.ncl_default","key":"DMVE0m7vOq"},{"type":"output","id":"ss-wSivRWZW23Bb5_Hgok","data":[],"key":"BR4bFagURs"}],"key":"rwAl3z7uRA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def make_map_plot(nplot_rows, nplot_cols, plot_index, data, plot_label):\n    \"\"\" Create a single map subplot. \"\"\"\n    ax = plt.subplot(nplot_rows, nplot_cols, plot_index, projection = ccrs.Robinson(central_longitude = 180))\n    cplot = plt.contourf(lons, lats, data,\n                         levels = contour_levels,\n                         cmap = color_map,\n                         extend = 'both',\n                         transform = ccrs.PlateCarree())\n    ax.coastlines(color = 'grey')\n    ax.text(0.01, 0.01, plot_label, fontsize = 14, transform = ax.transAxes)\n    return cplot, ax","key":"mqq685G5Zr"},{"type":"output","id":"YEytlDklyL3cYOjNbER5V","data":[],"key":"aQAnx7zXqP"}],"key":"BfSJg2r4oK"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# Generate plot (may take a while as many individual maps are generated)\nnumPlotRows = 8\nnumPlotCols = 4\nfigWidth = 20\nfigHeight = 30\n\nfig, axs = plt.subplots(numPlotRows, numPlotCols, figsize=(figWidth,figHeight))\n\nlats = winter_trends.lat\nlons = winter_trends.lon\n\n# Create ensemble member plots\nfor ensemble_index in range(30):\n    plot_data = winter_trends.isel(member_id = ensemble_index)\n    plot_index = ensemble_index + 1\n    plot_label = str(plot_index)\n    plotRow = ensemble_index // numPlotCols\n    plotCol = ensemble_index % numPlotCols\n    # Retain axes objects for figure colorbar\n    cplot, axs[plotRow, plotCol] = make_map_plot(numPlotRows, numPlotCols, plot_index, plot_data, plot_label)\n\n# Create plots for the ensemble mean, observations, and a figure color bar.\ncplot, axs[7,2] = make_map_plot(numPlotRows, numPlotCols, 31, winter_trends_mean, 'EM')\n\nlats = obs_winter_trends.lat\nlons = obs_winter_trends.lon\ncplot, axs[7,3] = make_map_plot(numPlotRows, numPlotCols, 32, obs_winter_trends.tempanomaly, 'OBS')\n\ncbar = fig.colorbar(cplot, ax=axs, orientation='horizontal', shrink = 0.7, pad = 0.02)\ncbar.ax.set_title('1979-2012 DJF surface air temperature trends (K/34 years)', fontsize = 16)\ncbar.set_ticks(contour_levels)\ncbar.set_ticklabels(contour_levels)","key":"WoOl6ra6TB"},{"type":"output","id":"BTERLZ4pp9S2EWwPw849E","data":[],"key":"amhS3ReYIS"}],"key":"Bc5E8h5Ght"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Close our client:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JNQA7yFoXS"}],"key":"BkHakVMuyx"}],"key":"dL3VHl8gZp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close()","key":"VDWgKXqYUL"},{"type":"output","id":"q1EB_KNUhTNtInXNCIdeK","data":[],"key":"SJbZfPSz7L"}],"key":"aRegQthnBm"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lMzJ9ZuMZ0"}],"key":"R8kMh2MF9M"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Summary","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SANH2pKu6x"}],"identifier":"summary","label":"Summary","html_id":"summary","implicit":true,"key":"bcvZk2dym3"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In this notebook, we used CESM LENS data hosted on AWS to recreate two key figures in the paper that describes the project.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"b8AjSSXxLL"}],"key":"Q61RANW8hP"},{"type":"heading","depth":3,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"What’s next?","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"nGlsca2wpn"}],"identifier":"whats-next","label":"What’s next?","html_id":"whats-next","implicit":true,"key":"r8l7qREBBT"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"More example workflows using these datasets may be added in the future.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"sf9nn1ud7n"}],"key":"wvx5mSy4XN"}],"key":"Cymgxvu7FE"}],"key":"zT32zmdKJU"},"references":{"cite":{"order":["Kay:2015a","Morice:2012a","Lenssen:2019a"],"data":{"Kay:2015a":{"label":"Kay:2015a","enumerator":"1","doi":"10.1175/BAMS-D-13-00255.1","html":"Kay, J. E., Deser, C., Phillips, A., Mai, A., Hannay, C., Strand, G., Arblaster, J. M., Bates, S. C., Danabasoglu, G., Edwards, J., Holland, M., Kushner, P., Lamarque, J.-F., Lawrence, D., Lindsday, K., Middleton, A., Munoz, E., Neale, R., Oleson, K., … Vertenstein, M. (2015). The Community Earth System Model (CESM) Large Ensemble Project. <i>Bull. Amer. Meteor. Soc.</i> <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1175/BAMS-D-13-00255.1\">10.1175/BAMS-D-13-00255.1</a>","url":"https://doi.org/10.1175/BAMS-D-13-00255.1"},"Morice:2012a":{"label":"Morice:2012a","enumerator":"2","doi":"10.1029/2011JD017187","html":"Morice, C. P., Kennedy, J. J., Rayner, N. A., & Jones, P. D. (2012). Quantifying uncertainties in global and regional temperature change using an ensemble of observational estimates: The HadCRUT4 data set. <i>J. Geophys. Res. Atmos.</i>, <i>117</i>(D8). <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1029/2011JD017187\">10.1029/2011JD017187</a>","url":"https://doi.org/10.1029/2011JD017187"},"Lenssen:2019a":{"label":"Lenssen:2019a","enumerator":"3","doi":"10.1029/2018JD029522","html":"Lenssen, N., Schmidt, G., Hansen, J., Menne, M., Persin, A., Ruedy, R., & Zyss, D. (2019). Improvements in the GISTEMP uncertainty model. <i>Journal of Geophysical Research: Atmospheres</i>, <i>124</i>(12), 6307–6326. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1029/2018JD029522\">10.1029/2018JD029522</a>","url":"https://doi.org/10.1029/2018JD029522"}}}},"footer":{"navigation":{"prev":{"title":"Enhanced Intake-ESM Catalog Demo","url":"/notebooks/foundations/enhanced-catalog","group":"Foundations"}}},"domain":"http://localhost:3000"}