{"version":2,"kind":"Notebook","sha256":"1e59f4c8d5fed946a07719102edb5d245a426cbb9592953e09f6eb321e816de8","slug":"notebooks.example-workflows.key-figures","location":"/notebooks/example-workflows/key-figures.ipynb","dependencies":[],"frontmatter":{"title":"Reproducing Key Figures from Kay et al. (2015)","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"literal":"Anderson Banihirwe","given":"Anderson","family":"Banihirwe"},"name":"Anderson Banihirwe","id":"contributors-myst-generated-uid-0"},{"nameParsed":{"literal":"Brian Bonnlander","given":"Brian","family":"Bonnlander"},"name":"Brian Bonnlander","id":"contributors-myst-generated-uid-1"},{"nameParsed":{"literal":"Jeff de La Beaujardière","given":"Jeff","non_dropping_particle":"de","family":"La Beaujardière"},"name":"Jeff de La Beaujardière","id":"contributors-myst-generated-uid-2"},{"nameParsed":{"literal":"Scott Henderson","given":"Scott","family":"Henderson"},"name":"Scott Henderson","id":"contributors-myst-generated-uid-3"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/cesm-lens-aws-cookbook","copyright":"2024","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"numbering":{"title":{"offset":1}},"source_url":"https://github.com/projectpythia/cesm-lens-aws-cookbook/blob/main/notebooks/example-workflows/key-figures.ipynb","edit_url":"https://github.com/projectpythia/cesm-lens-aws-cookbook/edit/main/notebooks/example-workflows/key-figures.ipynb","exports":[{"format":"ipynb","filename":"key-figures.ipynb","url":"/cesm-lens-aws-cookbook/build/key-figures-3e64b2e954b0371947817b4bed8ff9f7.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Bgc8GgBMaY"}],"key":"FVowha9Uiu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IaIn9MGgoF"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"fdlfLPiXKQ"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"This notebook demonstrates how one might use the NCAR Community Earth System Model (CESM) Large Ensemble (LENS) data hosted on AWS S3. The notebook shows how to reproduce figures 2 and 4 from the ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Uh8HcLi06d"},{"type":"cite","url":"https://doi.org/10.1175/BAMS-D-13-00255.1","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Kay et al. (2015) paper","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"qZqaX3ocnW"}],"kind":"narrative","label":"Kay:2015a","identifier":"https://doi.org/10.1175/BAMS-D-13-00255.1","enumerator":"1","key":"tagvq5U9P0"},{"type":"text","value":" describing the CESM LENS dataset ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"Kp5l7nAu2o"},{"type":"citeGroup","kind":"parenthetical","children":[{"type":"cite","kind":"parenthetical","label":"Kay:2015a","identifier":"kay:2015a","children":[{"type":"text","value":"Kay ","key":"yYPRQR5AhE"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"WSUzonvxWf"}],"key":"iaoy7Z8pRL"},{"type":"text","value":", 2015","key":"N860bqZVtD"}],"enumerator":"1","key":"H5QaqusqQo"}],"key":"QhsU12eDvM"},{"type":"text","value":".","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QBQCuBXZvj"}],"key":"iqVMVgk031"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This resource is intended to be helpful for people not familiar with elements of the ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"PzkC10y5gv"},{"type":"link","url":"https://pangeo.io/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Pangeo","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"WasO2ZUYlJ"}],"urlSource":"https://pangeo.io/","key":"g8Jhr5uSOZ"},{"type":"text","value":" framework including Jupyter Notebooks, ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"uWKkhRzFdG"},{"type":"link","url":"https://docs.xarray.dev/en/stable/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Xarray","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"rOEpeAxQYn"}],"urlSource":"https://docs.xarray.dev/en/stable/","key":"TFHWPurBo0"},{"type":"text","value":", and ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Y15AMOz4sS"},{"type":"link","url":"https://zarr.readthedocs.io/en/stable/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Zarr","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"QnRufUD4Am"}],"urlSource":"https://zarr.readthedocs.io/en/stable/","key":"p8N8eerYvx"},{"type":"text","value":" data format, or with the original paper, so it includes additional explanation.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"K3tJpUdHr6"}],"key":"JGIlHuKysT"}],"key":"UuPZ7YmQTk"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Prerequisites","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Co6nHY2VdC"}],"identifier":"prerequisites","label":"Prerequisites","html_id":"prerequisites","implicit":true,"key":"E8DI1KOrBM"},{"type":"table","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableRow","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Concepts","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"L6yFozBLQ1"}],"key":"ovbUvne4qq"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Importance","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ko0HAzguSi"}],"key":"KCq3bnCWm3"},{"type":"tableCell","header":true,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Notes","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"lqifLbFSJv"}],"key":"HKap8F0a16"}],"key":"eo4jci1QWE"},{"type":"tableRow","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"link","url":"https://foundations.projectpythia.org/core/xarray/xarray-intro","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Intro to Xarray","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q7K6DHJPWs"}],"urlSource":"https://foundations.projectpythia.org/core/xarray/xarray-intro","key":"PKGndGeVfz"}],"key":"POhXcj616L"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Necessary","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Ufuuoa6IKR"}],"key":"eJvFoEHYyb"},{"type":"tableCell","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[],"key":"rPK3tjPmP0"}],"key":"rBdqzZOoeM"},{"type":"tableRow","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Dask","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"xCtJ2r9ffM"}],"key":"juvOzuwWQX"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Helpful","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"URSom8S1UO"}],"key":"k3QIZacX5c"},{"type":"tableCell","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[],"key":"vdjI8BJnUX"}],"key":"DYK9E3YEdc"}],"key":"D504w7oZBt"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Time to learn","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"twvy7m03ll"}],"key":"LJ7QqqH81T"},{"type":"text","value":": 30 minutes","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"NSAXFH16oQ"}],"key":"bY6OLkN8dD"}],"key":"bU3DS95hpu"}],"key":"oLqUFTIJFm"}],"key":"gCn3NfKqP2"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y7V2PaR3iV"}],"key":"C9LmqVRH5Q"},{"type":"block","kind":"notebook-content","children":[{"type":"div","class":"alert alert-warning","children":[{"type":"strong","children":[{"type":"text","value":"NOTE: ","key":"DAJypLMkwl"}],"key":"mqUd6UpRuI"},{"type":"text","value":"In this notebook, we access very large cloud-served datasets and use ","key":"MTEpCLBUSB"},{"type":"link","url":"https://dask.org","children":[{"type":"text","value":"Dask","key":"lNaZcXG3Pw"}],"urlSource":"https://dask.org","key":"Yq99Dzu7y7"},{"type":"text","value":" to parallelize our workflow. The end-to-end execution time may be on the order of an hour or more, depending on your computing resources.","key":"QSVEdqU04l"}],"key":"RoC2hrqUQz"}],"key":"adjbb5Ybl7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Imports","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hxAwdLxs5r"}],"identifier":"imports","label":"Imports","html_id":"imports","implicit":true,"key":"ocW7YqOdqS"}],"key":"u05fBLJibm"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import sys\nimport warnings\nwarnings.filterwarnings(\"ignore\")\n\nimport intake\nimport matplotlib.pyplot as plt\nfrom dask.distributed import Client\nimport numpy as np\nimport pandas as pd\nimport xarray as xr\nimport cmaps  # for NCL colormaps\nimport cartopy.crs as ccrs\nimport dask\nimport s3fs","key":"f9IbLWUIN4"},{"type":"output","id":"G8Sq51nIw1lXXGtPT--Gp","data":[],"key":"zzoidD1K50"}],"key":"T279yde8iG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dask.config.set({\"distributed.scheduler.worker-saturation\": 1.0})","key":"E7vaU6BTaT"},{"type":"output","id":"bBMhEoU_G1XT7g1C-sOxg","data":[{"output_type":"execute_result","execution_count":2,"metadata":{},"data":{"text/plain":{"content":"<dask.config.set at 0x7f83ff373c90>","content_type":"text/plain"}}}],"key":"rXSSlZONX3"}],"key":"iabCxtqdAq"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create and Connect to Dask Distributed Cluster","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ubwltprqM4"}],"identifier":"create-and-connect-to-dask-distributed-cluster","label":"Create and Connect to Dask Distributed Cluster","html_id":"create-and-connect-to-dask-distributed-cluster","implicit":true,"key":"xlO5uBCYLP"}],"visibility":"show","key":"tpRdKUDKGy"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Here we’ll use a dask cluster to parallelize our analysis.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KjVHOVGmdB"}],"key":"i4x0B607mY"}],"key":"hHriFoI4L2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"platform = sys.platform\n\nif (platform == 'win32'):\n    import multiprocessing.popen_spawn_win32\nelse:\n    import multiprocessing.popen_spawn_posix","key":"oz6Wxs9296"},{"type":"output","id":"8EJsZnCysuLPtwvUCOrjB","data":[],"key":"UobyhWeVcX"}],"key":"ADdV3dqbNh"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client = Client()\nclient","key":"xWgXP5tBFO"},{"type":"output","id":"WJBSzYpv2ajiTNfdKWjH7","data":[{"output_type":"execute_result","execution_count":4,"metadata":{},"data":{"text/plain":{"content":"<Client: 'tcp://127.0.0.1:41413' processes=4 threads=4, memory=15.62 GiB>","content_type":"text/plain"},"text/html":{"content":"<div>\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\"> </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px;\">Client</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Client-761effe6-a708-11f0-8ecf-000d3a36e9c1</p>\n        <table style=\"width: 100%; text-align: left;\">\n\n        <tr>\n        \n            <td style=\"text-align: left;\"><strong>Connection method:</strong> Cluster object</td>\n            <td style=\"text-align: left;\"><strong>Cluster type:</strong> distributed.LocalCluster</td>\n        \n        </tr>\n\n        \n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:8787/status\" target=\"_blank\">http://127.0.0.1:8787/status</a>\n                </td>\n                <td style=\"text-align: left;\"></td>\n            </tr>\n        \n\n        </table>\n\n        \n\n        \n            <details>\n            <summary style=\"margin-bottom: 20px;\"><h3 style=\"display: inline;\">Cluster Info</h3></summary>\n            <div class=\"jp-RenderedHTMLCommon jp-RenderedHTML jp-mod-trusted jp-OutputArea-output\">\n    <div style=\"width: 24px; height: 24px; background-color: #e1e1e1; border: 3px solid #9D9D9D; border-radius: 5px; position: absolute;\">\n    </div>\n    <div style=\"margin-left: 48px;\">\n        <h3 style=\"margin-bottom: 0px; margin-top: 0px;\">LocalCluster</h3>\n        <p style=\"color: #9D9D9D; margin-bottom: 0px;\">a287148f</p>\n        <table style=\"width: 100%; text-align: left;\">\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:8787/status\" target=\"_blank\">http://127.0.0.1:8787/status</a>\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Workers:</strong> 4\n                </td>\n            </tr>\n            <tr>\n                <td style=\"text-align: left;\">\n                    <strong>Total threads:</strong> 4\n                </td>\n                <td style=\"text-align: left;\">\n                    <strong>Total memory:</strong> 15.62 GiB\n                </td>\n            </tr>\n            \n            <tr>\n    <td style=\"text-align: left;\"><strong>Status:</strong> running</td>\n    <td style=\"text-align: left;\"><strong>Using processes:</strong> True</td>\n</tr>\n\n            \n        </table>\n\n        <details>\n            <summary style=\"margin-bottom: 20px;\">\n                <h3 style=\"display: inline;\">Scheduler Info</h3>\n            </summary>\n\n            <div style=\"\">\n    <div>\n        <div style=\"width: 24px; height: 24px; background-color: #FFF7E5; border: 3px solid #FF6132; border-radius: 5px; position: absolute;\"> </div>\n        <div style=\"margin-left: 48px;\">\n            <h3 style=\"margin-bottom: 0px;\">Scheduler</h3>\n            <p style=\"color: #9D9D9D; margin-bottom: 0px;\">Scheduler-d9226178-41cd-42c4-910c-f74fae011218</p>\n            <table style=\"width: 100%; text-align: left;\">\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Comm:</strong> tcp://127.0.0.1:41413\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Workers:</strong> 0 \n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Dashboard:</strong> <a href=\"http://127.0.0.1:8787/status\" target=\"_blank\">http://127.0.0.1:8787/status</a>\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total threads:</strong> 0\n                    </td>\n                </tr>\n                <tr>\n                    <td style=\"text-align: left;\">\n                        <strong>Started:</strong> Just now\n                    </td>\n                    <td style=\"text-align: left;\">\n                        <strong>Total memory:</strong> 0 B\n                    </td>\n                </tr>\n            </table>\n        </div>\n    </div>\n\n    <details style=\"margin-left: 48px;\">\n        <summary style=\"margin-bottom: 20px;\">\n            <h3 style=\"display: inline;\">Workers</h3>\n        </summary>\n\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 0</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:46627\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:42959/status\" target=\"_blank\">http://127.0.0.1:42959/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:43771\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-8b8oa_vo\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 1</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:42879\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:46469/status\" target=\"_blank\">http://127.0.0.1:46469/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:36593\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-rbe0f23u\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 2</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:33283\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:37437/status\" target=\"_blank\">http://127.0.0.1:37437/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:44467\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-nhg3fqs9\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n        <div style=\"margin-bottom: 20px;\">\n            <div style=\"width: 24px; height: 24px; background-color: #DBF5FF; border: 3px solid #4CC9FF; border-radius: 5px; position: absolute;\"> </div>\n            <div style=\"margin-left: 48px;\">\n            <details>\n                <summary>\n                    <h4 style=\"margin-bottom: 0px; display: inline;\">Worker: 3</h4>\n                </summary>\n                <table style=\"width: 100%; text-align: left;\">\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Comm: </strong> tcp://127.0.0.1:33889\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Total threads: </strong> 1\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Dashboard: </strong> <a href=\"http://127.0.0.1:35941/status\" target=\"_blank\">http://127.0.0.1:35941/status</a>\n                        </td>\n                        <td style=\"text-align: left;\">\n                            <strong>Memory: </strong> 3.91 GiB\n                        </td>\n                    </tr>\n                    <tr>\n                        <td style=\"text-align: left;\">\n                            <strong>Nanny: </strong> tcp://127.0.0.1:40929\n                        </td>\n                        <td style=\"text-align: left;\"></td>\n                    </tr>\n                    <tr>\n                        <td colspan=\"2\" style=\"text-align: left;\">\n                            <strong>Local directory: </strong> /tmp/dask-scratch-space/worker-3g41u2tz\n                        </td>\n                    </tr>\n\n                    \n\n                    \n\n                </table>\n            </details>\n            </div>\n        </div>\n        \n\n    </details>\n</div>\n\n        </details>\n    </div>\n</div>\n            </details>\n        \n\n    </div>\n</div>","content_type":"text/html"}}}],"key":"q2zk6GT51G"}],"key":"ForDsFZMi1"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load and Prepare Data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sgjiyJbNy1"}],"identifier":"load-and-prepare-data","label":"Load and Prepare Data","html_id":"load-and-prepare-data","implicit":true,"key":"FPfeJInFyd"}],"visibility":"show","key":"a4ziEzLl6y"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"catalog_url = 'https://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json'\ncol = intake.open_esm_datastore(catalog_url)\ncol","key":"vXEO9Gt3wx"},{"type":"output","id":"iywWR6C9FGNEYCoZ3yFT-","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mAttributeError\u001b[39m                            Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[5]\u001b[39m\u001b[32m, line 2\u001b[39m\n\u001b[32m      1\u001b[39m catalog_url = \u001b[33m'\u001b[39m\u001b[33mhttps://ncar-cesm-lens.s3-us-west-2.amazonaws.com/catalogs/aws-cesm1-le.json\u001b[39m\u001b[33m'\u001b[39m\n\u001b[32m----> \u001b[39m\u001b[32m2\u001b[39m col = \u001b[43mintake\u001b[49m\u001b[43m.\u001b[49m\u001b[43mopen_esm_datastore\u001b[49m\u001b[43m(\u001b[49m\u001b[43mcatalog_url\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m      3\u001b[39m col\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cla-cookbook-dev/lib/python3.11/site-packages/intake_esm/core.py:124\u001b[39m, in \u001b[36mesm_datastore.__init__\u001b[39m\u001b[34m(self, obj, progressbar, sep, registry, read_csv_kwargs, columns_with_iterables, storage_options, threaded, **intake_kwargs)\u001b[39m\n\u001b[32m    122\u001b[39m     \u001b[38;5;28mself\u001b[39m.esmcat = ESMCatalogModel.from_dict(obj)\n\u001b[32m    123\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m124\u001b[39m     \u001b[38;5;28mself\u001b[39m.esmcat = \u001b[43mESMCatalogModel\u001b[49m\u001b[43m.\u001b[49m\u001b[43mload\u001b[49m\u001b[43m(\u001b[49m\n\u001b[32m    125\u001b[39m \u001b[43m        \u001b[49m\u001b[43mobj\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mstorage_options\u001b[49m\u001b[43m=\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mstorage_options\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mread_csv_kwargs\u001b[49m\u001b[43m=\u001b[49m\u001b[43mread_csv_kwargs\u001b[49m\n\u001b[32m    126\u001b[39m \u001b[43m    \u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    128\u001b[39m \u001b[38;5;28mself\u001b[39m.derivedcat = registry \u001b[38;5;129;01mor\u001b[39;00m default_registry\n\u001b[32m    129\u001b[39m \u001b[38;5;28mself\u001b[39m._entries = {}\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cla-cookbook-dev/lib/python3.11/site-packages/intake_esm/cat.py:255\u001b[39m, in \u001b[36mESMCatalogModel.load\u001b[39m\u001b[34m(cls, json_file, storage_options, read_csv_kwargs)\u001b[39m\n\u001b[32m    253\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m \u001b[33m'\u001b[39m\u001b[33mlast_updated\u001b[39m\u001b[33m'\u001b[39m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;129;01min\u001b[39;00m data:\n\u001b[32m    254\u001b[39m     data[\u001b[33m'\u001b[39m\u001b[33mlast_updated\u001b[39m\u001b[33m'\u001b[39m] = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m255\u001b[39m cat = \u001b[38;5;28;43mcls\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mmodel_validate\u001b[49m\u001b[43m(\u001b[49m\u001b[43mdata\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    256\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m cat.catalog_file:\n\u001b[32m    257\u001b[39m     cat._frames = cat._df_from_file(cat, _mapper, storage_options, read_csv_kwargs)\n\n    \u001b[31m[... skipping hidden 1 frame]\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/micromamba/envs/cla-cookbook-dev/lib/python3.11/site-packages/intake_esm/cat.py:76\u001b[39m, in \u001b[36mAssets._validate_data_format\u001b[39m\u001b[34m(cls, model)\u001b[39m\n\u001b[32m     74\u001b[39m \u001b[38;5;129m@pydantic\u001b[39m.model_validator(mode=\u001b[33m'\u001b[39m\u001b[33mafter\u001b[39m\u001b[33m'\u001b[39m)\n\u001b[32m     75\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34m_validate_data_format\u001b[39m(\u001b[38;5;28mcls\u001b[39m, model):\n\u001b[32m---> \u001b[39m\u001b[32m76\u001b[39m     data_format, format_column_name = \u001b[43mmodel\u001b[49m\u001b[43m.\u001b[49m\u001b[43mformat\u001b[49m, model.format_column_name\n\u001b[32m     77\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m data_format \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m \u001b[38;5;129;01mand\u001b[39;00m format_column_name \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m     78\u001b[39m         \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[33m'\u001b[39m\u001b[33mCannot set both format and format_column_name\u001b[39m\u001b[33m'\u001b[39m)\n\n\u001b[31mAttributeError\u001b[39m: 'pydantic_core._pydantic_core.ValidationInfo' object has no attribute 'format'","ename":"AttributeError","evalue":"'pydantic_core._pydantic_core.ValidationInfo' object has no attribute 'format'"}],"key":"bgIIiqWUl0"}],"key":"PsgFzRZWks"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show the first few lines of the catalog:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"l0KxU6vdXq"}],"key":"DPG73xaWBd"}],"key":"GrcD0XLB0O"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col.df.head(10)","key":"eW0r5sjXst"},{"type":"output","id":"v9vDUY8BTgiTrSEBqA06G","data":[],"key":"G3dZOPS34k"}],"key":"YIPtmWIL2t"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Show expanded version of collection structure with details:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BNmwkCwmLr"}],"key":"aWIAQ1C2KS"}],"key":"VPFMYRPbbC"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col.keys_info().head()","key":"rAvnMiuwvO"},{"type":"output","id":"WlbqQZi7HjUmgokgm6eyd","data":[],"key":"IFLOUn0buL"}],"key":"tvwj9w9s5J"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Extract data needed to construct Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ra8TAaZNgv"}],"identifier":"extract-data-needed-to-construct-figure-2","label":"Extract data needed to construct Figure 2","html_id":"extract-data-needed-to-construct-figure-2","implicit":true,"key":"bQREiv02CG"}],"key":"Zbp34mpGCL"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Search the catalog to find the desired data, in this case the reference height temperature of the atmosphere, at daily time resolution, for the Historical, 20th Century, and RCP8.5 (IPCC Representative Concentration Pathway 8.5) experiments.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"CrY4yE3Pw7"}],"key":"T65LnPDK2T"}],"key":"WEMg6a3Fic"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col_subset = col.search(frequency=[\"daily\", \"monthly\"], component=\"atm\", variable=\"TREFHT\",\n                        experiment=[\"20C\", \"RCP85\", \"HIST\"])\n\ncol_subset","key":"xHprkYklOD"},{"type":"output","id":"G0ipsI_mCK3XJapmGGI6H","data":[],"key":"CBdEMrIopk"}],"key":"T7a0CrghjZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"col_subset.df","key":"nCYEHtnr5c"},{"type":"output","id":"50rcCDPAtM2YYZZ-OkCbP","data":[],"key":"pwWPxqJ0tO"}],"key":"ub15EqNUIn"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Load catalog entries for subset into a dictionary of Xarray Datasets:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"NNfLAxxZaG"}],"key":"mn8uUC8Jtc"}],"key":"eLKwizxT82"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"dsets = col_subset.to_dataset_dict(zarr_kwargs={\"consolidated\": True}, storage_options={\"anon\": True})\nprint(f\"\\nDataset dictionary keys:\\n {dsets.keys()}\")","key":"ffOBee0wG0"},{"type":"output","id":"WvG8ejFqZg532fUBQqH69","data":[],"key":"UPwPoQbckT"}],"key":"ZCJwZ2cCsQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define Xarray Datasets corresponding to the three experiments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C4IvGPmggA"}],"key":"qMn6DLUfqB"}],"key":"wr1rSlxVQo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_HIST = dsets['atm.HIST.monthly']\nds_20C = dsets['atm.20C.daily']\nds_RCP85 = dsets['atm.RCP85.daily']","key":"BRAVXzumCs"},{"type":"output","id":"T1Nfo5DqB6CPxGGX3ujdx","data":[],"key":"K7me0UTXMC"}],"key":"hzT1VnbmPT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Use the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"a1fYEzFopT"},{"type":"inlineCode","value":"dask.distributed","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gvj6Y4ufe5"},{"type":"text","value":" utility function to display size of each dataset:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z08g7iYxau"}],"key":"iAZnR0LmNh"}],"key":"HxKuqIu22X"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"from dask.utils import format_bytes\nprint(f\"Historical: {format_bytes(ds_HIST.nbytes)}\\n\"\n      f\"20th Century: {format_bytes(ds_20C.nbytes)}\\n\"\n      f\"RCP8.5: {format_bytes(ds_RCP85.nbytes)}\")","key":"tX9fx4FEEf"},{"type":"output","id":"aoieK2Rm3TofYocaMk-L1","data":[],"key":"EJMFzl7ZTc"}],"key":"DJbzLDGm5p"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now, extract the Reference Height Temperature data variable:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W8DotFAJqA"}],"key":"R1TM3rMPiZ"}],"key":"Nq0HGkDaC9"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_hist = ds_HIST[\"TREFHT\"]\nt_20c = ds_20C[\"TREFHT\"]\nt_rcp = ds_RCP85[\"TREFHT\"]\nt_20c","key":"Elnvac8Fnx"},{"type":"output","id":"WdWtAdx4-Zbo8JytJ_v7-","data":[],"key":"Uevnl8UmNh"}],"key":"tIqGumSlxV"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"The global surface temperature anomaly was computed relative to the 1961-90 base period in the Kay et al. paper, so extract that time slice:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"FbKvVyQYqw"}],"key":"X4zzXvXXKX"}],"key":"Ha8hVDIAeo"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_ref = t_20c.sel(time=slice(\"1961\", \"1990\"))","key":"PQ2piZtDVC"},{"type":"output","id":"1rl_bUiAOHSaoQVfJCzXV","data":[],"key":"RbN8AN3U2w"}],"key":"l18Vn7UIbB"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jkuGQbb3n9"}],"identifier":"figure-2","label":"Figure 2","html_id":"figure-2","implicit":true,"key":"cXPeHwC0Re"}],"visibility":"show","key":"bvcykghmex"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read grid cell areas","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pKeVoboBIN"}],"identifier":"read-grid-cell-areas","label":"Read grid cell areas","html_id":"read-grid-cell-areas","implicit":true,"key":"jgKz0bKXw0"}],"key":"yCEsuM7R6C"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Cell size varies with latitude, so this must be accounted for when computing the global mean.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kbCXycYj6T"}],"key":"gib0WZe22y"}],"key":"Y7aKiXGWLX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cat = col.search(frequency=\"static\", component=\"atm\", experiment=[\"20C\"])\n_, grid = cat.to_dataset_dict(aggregate=False, storage_options={'anon':True}, zarr_kwargs={\"consolidated\": True}).popitem()\ngrid","key":"JKnJSy7hx5"},{"type":"output","id":"XYnCqKCZYXyQuE1VBwpVf","data":[],"key":"xTKyhaILB7"}],"key":"NbDYjftaV4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"cell_area = grid.area.load()\ntotal_area = cell_area.sum()\ncell_area","key":"BA5Twrz0X2"},{"type":"output","id":"gNobJEr72rQImNNjoJ3mP","data":[],"key":"y3g6BRz20r"}],"key":"jhkZFH8EEs"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define weighted means","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SmSLk77wXy"}],"identifier":"define-weighted-means","label":"Define weighted means","html_id":"define-weighted-means","implicit":true,"key":"wL4EW6CsRd"}],"key":"bL3XyNDI05"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note: ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"sDNs5Aew8j"},{"type":"inlineCode","value":"resample(time=\"AS\")","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Q8EqMoYKhr"},{"type":"text","value":" does an annual resampling based on start of calendar year. See documentation for ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JDhlMVSoas"},{"type":"link","url":"https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Pandas resampling options","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"E5GOmmi7RU"}],"urlSource":"https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#dateoffset-objects","key":"yIyGeNnTqB"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ISEGYkVmha"}],"key":"NmmjP2vtdK"}],"key":"e780jVtWGP"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"t_ref_ts = (\n    (t_ref.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n    / total_area\n).mean(dim=(\"time\", \"member_id\"))\n\nt_hist_ts = (\n    (t_hist.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area\n\nt_20c_ts = (\n    (t_20c.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area\n\nt_rcp_ts = (\n    (t_rcp.resample(time=\"AS\").mean(\"time\") * cell_area).sum(dim=(\"lat\", \"lon\"))\n) / total_area","key":"UhTYcPZrDp"},{"type":"output","id":"0lO4l_w7jy6vF1MquOhRo","data":[],"key":"Hwr8vof6RJ"}],"key":"iAyx9mfVM5"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Read data and compute means","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DevQsndas3"}],"identifier":"read-data-and-compute-means","label":"Read data and compute means","html_id":"read-data-and-compute-means","implicit":true,"key":"oXPNXRjyLS"}],"key":"ciwezxr3t6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Dask’s “lazy execution” philosophy means that until this point we have not actually read the bulk of the data. Steps 1, 3, and 4 take a while to complete, so we include the Notebook “cell magic” directive ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"i9erdiO8TN"},{"type":"inlineCode","value":"%%time","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f20hSGvinB"},{"type":"text","value":" to display elapsed and CPU times after computation.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HznW5iFBHY"}],"key":"rn307PYQKf"}],"key":"KcVHxYkxog"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 1 (takes a while)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pRbbS8feUM"}],"key":"bFHE7fqCua"}],"key":"c1l5iogr1U"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# this cell takes a while, be patient\nt_ref_mean = t_ref_ts.load()\nt_ref_mean","key":"oyncAvRfQh"},{"type":"output","id":"9wQDaAyQZSEJ2H1dHt6Jk","data":[],"key":"EGGJMJURiz"}],"key":"riDy6Ezytt"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 2 (executes quickly)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TpUVq9lAJE"}],"key":"f0AgG7xAJ1"}],"key":"zQ6y8nc8Qe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time \nt_hist_ts_df = t_hist_ts.to_series().T\n#t_hist_ts_df.head()","key":"iirwUt9wzd"},{"type":"output","id":"5pX-3NXN3MfZnMa3Mc9b-","data":[],"key":"ZrCZBL7ZPM"}],"key":"M8WWO7Y1K6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 3 (takes even longer than Step 1)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JrLY5m3cxs"}],"key":"uOOeEyq28d"}],"key":"ExaUc4tDak"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\nt_20c_ts_df = t_20c_ts.to_series().unstack().T\nt_20c_ts_df.head()","key":"nZuLnw6SaL"},{"type":"output","id":"Vew-lNbS5n0BhqWmYXBMy","data":[],"key":"rVX6s5azv7"}],"key":"Fz2MC0PWHK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Step 4 (similar to Step 3 in its execution time)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"C8yNFQAmJ3"}],"key":"AGyO57Vcdl"}],"key":"eGB2F3axHp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# This also takes a while\nt_rcp_ts_df = t_rcp_ts.to_series().unstack().T\nt_rcp_ts_df.head()","key":"CLBF2ryEwq"},{"type":"output","id":"myQa1JN24hCE1iAyYfypR","data":[],"key":"mnq3scwvEf"}],"key":"ZGJlzhu4ZZ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get observations for Figure 2 (HadCRUT4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"DXTM2SgA8o"}],"identifier":"get-observations-for-figure-2-hadcrut4","label":"Get observations for Figure 2 (HadCRUT4)","html_id":"get-observations-for-figure-2-hadcrut4","implicit":true,"key":"p6SDOaUqL6"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The HadCRUT4 temperature dataset is described by ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"qRziIjtQKi"},{"type":"citeGroup","kind":"narrative","children":[{"type":"cite","kind":"narrative","label":"Morice:2012a","identifier":"morice:2012a","children":[{"type":"text","value":"Morice ","key":"XYAIBykymM"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"o2HSAoMVGW"}],"key":"dIY3oIUi9Q"},{"type":"text","value":" (2012)","key":"RjuNuUSIpr"}],"enumerator":"2","key":"fb7kcSJxvD"}],"key":"Pee86qdzsl"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"QBDamZXE2X"}],"key":"v5g0BfyiCT"}],"key":"L3B6yqjzqE"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Observational time series data for comparison with ensemble average:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WIdNg3qhq2"}],"key":"KSxOUfoZNj"}],"key":"JJuCC2sNPi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obsDataURL = \"https://www.esrl.noaa.gov/psd/thredds/dodsC/Datasets/cru/hadcrut4/air.mon.anom.median.nc\"\nds = xr.open_dataset(obsDataURL).load()\nds","key":"m8ZY5hcsAh"},{"type":"output","id":"XWPKhmJH_lNiQHMe-yNyZ","data":[],"key":"XMugHzacBg"}],"key":"c40eOzNrt6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def weighted_temporal_mean(ds):\n    \"\"\"\n    weight by days in each month\n    \"\"\"\n    time_bound_diff = ds.time_bnds.diff(dim=\"nbnds\")[:, 0]\n    wgts = time_bound_diff.groupby(\"time.year\") / time_bound_diff.groupby(\n        \"time.year\"\n    ).sum(xr.ALL_DIMS)\n    obs = ds[\"air\"]\n    cond = obs.isnull()\n    ones = xr.where(cond, 0.0, 1.0)\n    obs_sum = (obs * wgts).resample(time=\"AS\").sum(dim=\"time\")\n    ones_out = (ones * wgts).resample(time=\"AS\").sum(dim=\"time\")\n    obs_s = (obs_sum / ones_out).mean((\"lat\", \"lon\")).to_series()\n    return obs_s","key":"rcRoX0cN1D"},{"type":"output","id":"0iLAq8dQTrDVQe-P1DOYK","data":[],"key":"KijRr9PDWI"}],"key":"At8ObeKdvj"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Limit observations to 20th century:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"lswDIqegwO"}],"key":"p7FYOzW5Tq"}],"key":"rkRPWEpdFB"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_s = weighted_temporal_mean(ds)\nobs_s = obs_s['1920':]\nobs_s.head()","key":"ROUfm0XQWA"},{"type":"output","id":"SZPgJ6QPNn2iuvh9wYsbv","data":[],"key":"Vpd6rmu20V"}],"key":"wowgRkAi0b"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"all_ts_anom = pd.concat([t_20c_ts_df, t_rcp_ts_df]) - t_ref_mean.data\nyears = [val.year for val in all_ts_anom.index]\nobs_years = [val.year for val in obs_s.index]","key":"jnzyEcJRPq"},{"type":"output","id":"mnONfcZWnM_yxb8AafJIj","data":[],"key":"pAyGEWCxar"}],"key":"E2aHF8f8s4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combine ensemble member 1 data from historical and 20th century experiments:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"y0VhjSagXn"}],"key":"w0MEUc4kdQ"}],"key":"qXeRH7hQD0"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"hist_anom = t_hist_ts_df - t_ref_mean.data\nmember1 = pd.concat([hist_anom.iloc[:-2], all_ts_anom.iloc[:,0]], verify_integrity=True)\nmember1_years = [val.year for val in member1.index]","key":"FdXz8yNeJz"},{"type":"output","id":"N8K752KcDl7FO6nCBK3BX","data":[],"key":"gc20EG1oiN"}],"key":"vVlDBVr1CZ"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plotting Figure 2","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pO3ABeyvuM"}],"identifier":"plotting-figure-2","label":"Plotting Figure 2","html_id":"plotting-figure-2","implicit":true,"key":"ZqQSNBoTAS"}],"key":"Ktta9eOEWk"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Global surface temperature anomaly (1961-90 base period) for individual ensemble members, and observations:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"oHl5rrwLgb"}],"key":"a0wi5hnCKH"}],"key":"MEMm97ZbXT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ax = plt.axes()\n\nax.tick_params(right=True, top=True, direction=\"out\", length=6, width=2, grid_alpha=0.5)\nax.plot(years, all_ts_anom.iloc[:,1:], color=\"grey\")\nax.plot(obs_years, obs_s['1920':], color=\"red\")\nax.plot(member1_years, member1, color=\"black\")\n\n\nax.text(\n    0.35,\n    0.4,\n    \"observations\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"red\",\n    fontsize=10,\n)\nax.text(\n    0.35,\n    0.33,\n    \"members 2-40\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"grey\",\n    fontsize=10,\n)\nax.text(\n    0.05,\n    0.2,\n    \"member 1\",\n    verticalalignment=\"bottom\",\n    horizontalalignment=\"left\",\n    transform=ax.transAxes,\n    color=\"black\",\n    fontsize=10,\n)\n\nax.set_xticks([1850, 1920, 1950, 2000, 2050, 2100])\nplt.ylim(-1, 5)\nplt.xlim(1850, 2100)\nplt.ylabel(\"Global Surface\\nTemperature Anomaly (K)\")\nplt.show()","key":"AHseEaxMOY"},{"type":"output","id":"CZCW0MdodY213bh6QOW1W","data":[],"key":"qZcdy4Crbo"}],"key":"PaGI8usk94"},{"type":"block","kind":"notebook-content","data":{"tags":[]},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Figure 4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rYYAmm5z8m"}],"identifier":"figure-4","label":"Figure 4","html_id":"figure-4","implicit":true,"key":"ZWM8fVQxni"}],"visibility":"show","key":"Qhpf2ACGMf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute linear trend for winter seasons","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HCXX9IXYcz"}],"identifier":"compute-linear-trend-for-winter-seasons","label":"Compute linear trend for winter seasons","html_id":"compute-linear-trend-for-winter-seasons","implicit":true,"key":"wekVP6PK6l"}],"key":"kWf0Dl5GiF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def linear_trend(da, dim=\"time\"):\n    da_chunk = da.chunk({dim: -1})\n    trend = xr.apply_ufunc(\n        calc_slope,\n        da_chunk,\n        vectorize=True,\n        input_core_dims=[[dim]],\n        output_core_dims=[[]],\n        output_dtypes=[np.float64],\n        dask=\"parallelized\",\n    )\n    return trend\n\n\ndef calc_slope(y):\n    \"\"\"ufunc to be used by linear_trend\"\"\"\n    x = np.arange(len(y))\n\n    # drop missing values (NaNs) from x and y\n    finite_indexes = ~np.isnan(y)\n    slope = np.nan if (np.sum(finite_indexes) < 2) else np.polyfit(x[finite_indexes], y[finite_indexes], 1)[0]\n    return slope","key":"kyER0wtFrE"},{"type":"output","id":"EO-Sk-HaXfQKaQ-AEcvCF","data":[],"key":"QYEPqzKTjb"}],"key":"WD2iVPMAWM"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute ensemble trends","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"I8yyG98rHP"}],"identifier":"compute-ensemble-trends","label":"Compute ensemble trends","html_id":"compute-ensemble-trends","implicit":true,"key":"j1nkG3Sfna"}],"key":"ZejjfHwCaH"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time \n# Takes several minutes\nt = xr.concat([t_20c, t_rcp], dim=\"time\")\nseasons = t.sel(time=slice(\"1979\", \"2012\")).resample(time=\"QS-DEC\").mean(\"time\")\n# Include only full seasons from 1979 and 2012\nseasons = seasons.sel(time=slice(\"1979\", \"2012\")).load()","key":"e8HVfisj1s"},{"type":"output","id":"jUh17vh1kRbgAqBxUnkb7","data":[],"key":"SWsprAVsKJ"}],"key":"jCvvA41Zmx"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"winter_seasons = seasons.sel(\n    time=seasons.time.where(seasons.time.dt.month == 12, drop=True)\n)\nwinter_trends = linear_trend(\n    winter_seasons.chunk({\"lat\": 20, \"lon\": 20, \"time\": -1})\n).load() * len(winter_seasons.time)\n\n# Compute ensemble mean from the first 30 members\nwinter_trends_mean = winter_trends.isel(member_id=range(30)).mean(dim='member_id')","key":"MthFsHz7lV"},{"type":"output","id":"fU3RYdwnBDIZVQlCkCGv1","data":[],"key":"VLWgMu7xRY"}],"key":"c6q2YfG04Y"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Make sure that we have 34 seasons:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EdUhDXsiWP"}],"key":"YTgbShT5hZ"}],"key":"vfo4mcMdBz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"assert len(winter_seasons.time) == 34","key":"HBAXvY4jfP"},{"type":"output","id":"98rKrXwUuehSQ1aRyE_Sl","data":[],"key":"iFLz2NBlZT"}],"key":"ZlWLaLlvd6"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Get observations for Figure 4 (NASA GISS GisTemp)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vgwxLJTB59"}],"identifier":"get-observations-for-figure-4-nasa-giss-gistemp","label":"Get observations for Figure 4 (NASA GISS GisTemp)","html_id":"get-observations-for-figure-4-nasa-giss-gistemp","implicit":true,"key":"fdgR1UAZMv"}],"key":"pR0vpKkE7A"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"This is observational time series data for comparison with ensemble average. Here we are using the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WQgbHgBCHY"},{"type":"link","url":"https://data.giss.nasa.gov/gistemp/","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"GISS Surface Temperature Analysis (GISTEMP v4)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mEkkR9eL4u"}],"urlSource":"https://data.giss.nasa.gov/gistemp/","key":"JmFGRn9UCo"},{"type":"text","value":" from NASA’s Goddard Institute of Space Studies ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZaVwzExFwA"},{"type":"citeGroup","kind":"parenthetical","children":[{"type":"cite","kind":"parenthetical","label":"Lenssen:2019a","identifier":"lenssen:2019a","children":[{"type":"text","value":"Lenssen ","key":"VA7bdzMwQC"},{"type":"emphasis","children":[{"type":"text","value":"et al.","key":"WHvEt7pB6t"}],"key":"ddW0A870zs"},{"type":"text","value":", 2019","key":"NeV3Ymnj8i"}],"enumerator":"3","key":"JsqGLJmseh"}],"key":"woS8h5mzv7"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XXe2L9CLoc"}],"key":"QbwyQhzJaN"}],"key":"pQxuHENYiw"},{"type":"block","kind":"notebook-content","children":[{"type":"admonition","kind":"note","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"Qf6ZSlyZjp"}],"key":"xVHHRMUWNJ"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We will point to Project Pythia’s ","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"yAWBGFGnfi"},{"type":"link","url":"https://jetstream-cloud.org","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Jetstream2","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"KXQpvhK1km"}],"urlSource":"https://jetstream-cloud.org","key":"MLLWk3C6Rg"},{"type":"text","value":" object-store copy of the original time series dataset, in Zarr format.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"q9kBS16Yrs"}],"key":"mvpd1XiP4J"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"The dataset was obtained from ","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"oyF2J12XdS"},{"type":"link","url":"https://data.giss.nasa.gov/gistemp/","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"NASA’s GISTEMP website","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"j64AUDQOpK"}],"urlSource":"https://data.giss.nasa.gov/gistemp/","key":"QwseD33cgQ"},{"type":"text","value":" in May 2024.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"SIj3Nc5K2Y"}],"key":"QYY7aTBAT7"}],"key":"ocaHSu86uk"}],"key":"iKW9USjcB7"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Define the URL to Project Pythia’s Jetstream2 Object Store and the path to the Zarr file.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tVyyfyZ1Bl"}],"key":"X7D4GTPfKm"}],"key":"E9UJsX6EP7"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"URL = 'https://js2.jetstream-cloud.org:8001'\nfilePath = 's3://pythia/gistemp1200_GHCNv4_ERSSTv5.zarr'","key":"ly9ZwAaCcA"},{"type":"output","id":"yxfoASd3g8i5wIyJWMK4k","data":[],"key":"pDRqrFFTtW"}],"key":"NxO3BkH19G"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a container for the S3 file system","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JWNsJADj7l"}],"key":"P2uV8NcvZB"}],"key":"ueC8R0Ty5q"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fs = s3fs.S3FileSystem(anon=True, client_kwargs=dict(endpoint_url=URL))","key":"K8d7t3cLSr"},{"type":"output","id":"NKUISAD3TTSHhcQfP-xH0","data":[],"key":"qNbzZETb0O"}],"key":"GqDhizJ0h1"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Link to the Zarr file as it exists on the S3 object store","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IqnBRfWDyX"}],"key":"DhI8KzZNxJ"}],"key":"ZyRagL6i5l"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"store = s3fs.S3Map(root=filePath, s3=fs, check=False )","key":"henAUAXwge"},{"type":"output","id":"2_XIezVBvWGkKvzaiZ0w-","data":[],"key":"qRfU7Witrw"}],"key":"ScOxCH85yY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = xr.open_zarr(store, consolidated=True, chunks=\"auto\")\nds","key":"PPfKM35dmm"},{"type":"output","id":"31xKs7Ik-R2nVyYUgXzFQ","data":[],"key":"z4fuORkviq"}],"key":"l6gtjX5Ia3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create an Xarray ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aAeD93C1eD"},{"type":"inlineCode","value":"Dataset","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IbbvNhTXC2"},{"type":"text","value":" from the Zarr object","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Iuw29NiRqQ"}],"key":"qdd63srudA"}],"key":"XEfeC1pWIT"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Remap longitude range from [-180, 180] to [0, 360] for plotting purposes:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rK2C7QkGmj"}],"key":"SGEPROHCly"}],"key":"RhzZf3E8S4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = ds.assign_coords(lon=((ds.lon + 360) % 360)).sortby('lon')\nds","key":"mGunPMCUu4"},{"type":"output","id":"H45Cu-S_reSSsvQcPempk","data":[],"key":"DOKPwhxOJw"}],"key":"clfLxB5qRw"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Compute observed trends","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ztp5dPzH2H"}],"identifier":"compute-observed-trends","label":"Compute observed trends","html_id":"compute-observed-trends","implicit":true,"key":"ltILfxR7by"}],"key":"tcW4qQi6iv"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Include only full seasons from 1979 through 2012:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m087oYB5Up"}],"key":"gtZYhoBFmX"}],"key":"ljw4AMwCPp"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_seasons = ds.sel(time=slice(\"1979\", \"2012\")).resample(time=\"QS-DEC\").mean(\"time\")\nobs_seasons = obs_seasons.sel(time=slice(\"1979\", \"2012\")).load()\nobs_winter_seasons = obs_seasons.sel(\n    time=obs_seasons.time.where(obs_seasons.time.dt.month == 12, drop=True)\n)\nobs_winter_seasons","key":"hqa5CslT6g"},{"type":"output","id":"vtKAh2Lg9f-Sgukf6GvUi","data":[],"key":"mmYo76RJNj"}],"key":"Fy96dYGpRb"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And compute observed winter trends:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"yzMiwOsmDA"}],"key":"vF3pexcgbH"}],"key":"tlJUbzI7dA"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"obs_winter_trends = linear_trend(\n    obs_winter_seasons.chunk({\"lat\": 20, \"lon\": 20, \"time\": -1})\n).load() * len(obs_winter_seasons.time)\nobs_winter_trends","key":"brSVMADMgz"},{"type":"output","id":"LhT1GgA_VeP-DzxmAoKIO","data":[],"key":"Qbpo1ea1ze"}],"key":"i7u7cLg8qz"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Plotting Figure 4","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"l8CUnlknFf"}],"identifier":"plotting-figure-4","label":"Plotting Figure 4","html_id":"plotting-figure-4","implicit":true,"key":"mL6ocb5l6X"}],"key":"bcNpuGieDE"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Global maps of historical (1979 - 2012) boreal winter (DJF) surface air trends:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"qZ6E7JfdAH"}],"key":"jCBahX1UYn"}],"key":"kOv9MIjcjk"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"contour_levels = [-6, -5, -4, -3, -2, -1.5, -1, -0.5, 0, 0.5, 1, 1.5, 2, 3, 4, 5, 6]\ncolor_map = cmaps.ncl_default","key":"ROJDLtUr7e"},{"type":"output","id":"08ZLnl9o966-CmYE4QQ1s","data":[],"key":"ONcnHOLCh1"}],"key":"bICZSPjivZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def make_map_plot(nplot_rows, nplot_cols, plot_index, data, plot_label):\n    \"\"\" Create a single map subplot. \"\"\"\n    ax = plt.subplot(nplot_rows, nplot_cols, plot_index, projection = ccrs.Robinson(central_longitude = 180))\n    cplot = plt.contourf(lons, lats, data,\n                         levels = contour_levels,\n                         cmap = color_map,\n                         extend = 'both',\n                         transform = ccrs.PlateCarree())\n    ax.coastlines(color = 'grey')\n    ax.text(0.01, 0.01, plot_label, fontsize = 14, transform = ax.transAxes)\n    return cplot, ax","key":"eCn72wLl0P"},{"type":"output","id":"GePH79dOkV2aPzzelWjhG","data":[],"key":"vnTbBFRotB"}],"key":"KiuIDBBr3q"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"%%time\n# Generate plot (may take a while as many individual maps are generated)\nnumPlotRows = 8\nnumPlotCols = 4\nfigWidth = 20\nfigHeight = 30\n\nfig, axs = plt.subplots(numPlotRows, numPlotCols, figsize=(figWidth,figHeight))\n\nlats = winter_trends.lat\nlons = winter_trends.lon\n\n# Create ensemble member plots\nfor ensemble_index in range(30):\n    plot_data = winter_trends.isel(member_id = ensemble_index)\n    plot_index = ensemble_index + 1\n    plot_label = str(plot_index)\n    plotRow = ensemble_index // numPlotCols\n    plotCol = ensemble_index % numPlotCols\n    # Retain axes objects for figure colorbar\n    cplot, axs[plotRow, plotCol] = make_map_plot(numPlotRows, numPlotCols, plot_index, plot_data, plot_label)\n\n# Create plots for the ensemble mean, observations, and a figure color bar.\ncplot, axs[7,2] = make_map_plot(numPlotRows, numPlotCols, 31, winter_trends_mean, 'EM')\n\nlats = obs_winter_trends.lat\nlons = obs_winter_trends.lon\ncplot, axs[7,3] = make_map_plot(numPlotRows, numPlotCols, 32, obs_winter_trends.tempanomaly, 'OBS')\n\ncbar = fig.colorbar(cplot, ax=axs, orientation='horizontal', shrink = 0.7, pad = 0.02)\ncbar.ax.set_title('1979-2012 DJF surface air temperature trends (K/34 years)', fontsize = 16)\ncbar.set_ticks(contour_levels)\ncbar.set_ticklabels(contour_levels)","key":"VXKFkA6Wos"},{"type":"output","id":"-ArWsAEj2mSpJjwt9A5p5","data":[],"key":"QLQzuv51Xl"}],"key":"hmisU1ln0R"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Close our client:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KnrtG49pEB"}],"key":"umnrrQ8KRt"}],"key":"wY7GvX41Yz"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"client.close()","key":"WQcH6eS1MG"},{"type":"output","id":"OWmZU2j9gsO1nToyEQ0lY","data":[],"key":"wiIC2m8k8q"}],"key":"R50B2i6GPa"},{"type":"block","kind":"notebook-content","children":[{"type":"thematicBreak","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HetEoMBXOg"}],"key":"bw0DkBI4uf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Summary","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"V4dCle19VY"}],"identifier":"summary","label":"Summary","html_id":"summary","implicit":true,"key":"omWfqAqXFE"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"In this notebook, we used CESM LENS data hosted on AWS to recreate two key figures in the paper that describes the project.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"QHEnytHiza"}],"key":"MFNTDMKXKU"},{"type":"heading","depth":3,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"What’s next?","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"e3cZbP4aHw"}],"identifier":"whats-next","label":"What’s next?","html_id":"whats-next","implicit":true,"key":"VUHsYl6n5f"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"More example workflows using these datasets may be added in the future.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"exRSfPOMNO"}],"key":"HAFMCmi8yS"}],"key":"kujVtx7FxU"}],"key":"jWHYIfYii3"},"references":{"cite":{"order":["Kay:2015a","Morice:2012a","Lenssen:2019a"],"data":{"Kay:2015a":{"label":"Kay:2015a","enumerator":"1","doi":"10.1175/BAMS-D-13-00255.1","html":"Kay, J. E., Deser, C., Phillips, A., Mai, A., Hannay, C., Strand, G., Arblaster, J. M., Bates, S. C., Danabasoglu, G., Edwards, J., Holland, M., Kushner, P., Lamarque, J.-F., Lawrence, D., Lindsday, K., Middleton, A., Munoz, E., Neale, R., Oleson, K., … Vertenstein, M. (2015). The Community Earth System Model (CESM) Large Ensemble Project. <i>Bull. Amer. Meteor. Soc.</i> <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1175/BAMS-D-13-00255.1\">10.1175/BAMS-D-13-00255.1</a>","url":"https://doi.org/10.1175/BAMS-D-13-00255.1"},"Morice:2012a":{"label":"Morice:2012a","enumerator":"2","doi":"10.1029/2011JD017187","html":"Morice, C. P., Kennedy, J. J., Rayner, N. A., & Jones, P. D. (2012). Quantifying uncertainties in global and regional temperature change using an ensemble of observational estimates: The HadCRUT4 data set. <i>J. Geophys. Res. Atmos.</i>, <i>117</i>(D8). <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1029/2011JD017187\">10.1029/2011JD017187</a>","url":"https://doi.org/10.1029/2011JD017187"},"Lenssen:2019a":{"label":"Lenssen:2019a","enumerator":"3","doi":"10.1029/2018JD029522","html":"Lenssen, N., Schmidt, G., Hansen, J., Menne, M., Persin, A., Ruedy, R., & Zyss, D. (2019). Improvements in the GISTEMP uncertainty model. <i>Journal of Geophysical Research: Atmospheres</i>, <i>124</i>(12), 6307–6326. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.1029/2018JD029522\">10.1029/2018JD029522</a>","url":"https://doi.org/10.1029/2018JD029522"}}}},"footer":{"navigation":{"prev":{"title":"Enhanced Intake-ESM Catalog Demo","url":"/notebooks/foundations/enhanced-catalog","group":"Foundations"}}},"domain":"http://localhost:3000"}